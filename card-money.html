<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scratch For Your Gift!</title>
    
    <!-- Tone.js for Audio Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Open Graph Data -->
    <meta property="og:image" content="https://placehold.co/1200x630/000000/00F2EA?text=67+TIKTOK+GIFT">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Custom Font: Clean, modern sans-serif -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* General Styles - Dark Background */
        body { margin: 0; padding: 0; background-color: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: 'Inter', sans-serif; overflow: hidden; color: #fff; }
        
        /* CARD FLOAT ANIMATION */
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        .card-container { 
            position: relative; width: 320px; height: 480px; background: #222; border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); overflow: hidden; 
            /* TikTok Style Border: Neon Cyan */
            border: 4px solid #00F2EA; 
            animation: float 4s ease-in-out infinite; /* Apply soft floating */
        } 
        
        #prize-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            padding: 20px; box-sizing: border-box;
            
            /* Clean Black Background with Subtle Pattern */
            background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)),
                        url('https://images.unsplash.com/photo-1547484110-9aa8f26487e9?q=80&w=600&auto=format&fit=crop'); /* Dark, simple background image */
            background-size: cover; 
            border-radius: 20px; z-index: 1;
        }
        
        /* Styled 67 Number (NEON GREEN POP) */
        .meme-number {
            font-size: 100px;
            font-weight: 900;
            color: #00FF00; /* NEON GREEN */
            text-shadow: 6px 6px 0px #000; /* Increased Black Shadow for pop */
            line-height: 1.0;
            margin-bottom: 20px;
            width: 100%;
        }
        
        /* Gift Code Display (High Contrast) */
        #gift-code-display {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            background: #FE2C55; /* TikTok Magenta/Pink background for code pop */
            padding: 10px 15px;
            border-radius: 8px;
            letter-spacing: 1px;
            margin-top: 0; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        /* Copy Button (Neon Cyan Accent) */
        #copy-gift-btn {
            background-color: #00F2EA; /* Neon Cyan */
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s;
        }
        #copy-gift-btn:hover {
            background-color: #00a8a8;
        }


        /* Canvas covers the whole container */
        canvas { 
            position: absolute; top: 0; left: 0; z-index: 2; cursor: pointer; border-radius: 20px; touch-action: none; transition: opacity 0.5s ease;
            width: 100%; 
            height: 100%;
        }
        
        .instructions { margin-top: 25px; color: #888; font-size: 13px; letter-spacing: 1px; text-transform: uppercase; animation: pulse 2s infinite; font-family: sans-serif; }
        
        /* Detail Message Box Styling */
        #detail-message-box {
            font-size: 14px;
            color: #ccc;
            margin-top: 30px;
            padding: 10px;
            max-width: 90%;
            border-top: 1px dashed #555;
        }

        /* Animation CSS (Updated for TikTok colors) */
        #confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; opacity: 0; transition: opacity 1s ease; }
        .petal { position: absolute; width: 8px; height: 8px; background: #00F2EA; border-radius: 50%; opacity: 0; transform: translateY(0); }
        @keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(480px) rotate(360deg); opacity: 0; } }
        /* Cyan Burst */
        .burst-effect { position: absolute; top: 50%; left: 50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(0, 242, 234, 0.5) 50%, rgba(255,255,255,0) 100%); border-radius: 50%; transform: translate(-50%, -50%); animation: burst 1s forwards; z-index: 4; }
        @keyframes burst { 0% { opacity: 1; transform: scale(0.5) translate(-50%, -50%); } 50% { opacity: 0.8; transform: scale(1.5) translate(-50%, -50%); } 100% { opacity: 0; transform: scale(2.0) translate(-50%, -50%); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="card-container">
        <div id="confetti-container"></div> 
        
        <div id="prize-layer">
            <!-- Styled 67 Number -->
            <div class="meme-number" id="meme-number-67">67</div>

            <!-- Gift Code Area -->
            <span id="gift-code-display">Code will appear here!</span>
            <button id="copy-gift-btn" onclick="copyGiftCode()">Copy Code</button>

            <!-- Optional Detail Message Area -->
            <div id="detail-message-box"></div>
        </div>

        <!-- CANVAS IS NOW DIRECTLY IN CARD-CONTAINER -->
        <canvas id="scratchCanvas"></canvas>
    </div>
    <p class="instructions">Rub screen to reveal</p>

    <script>
        // --- TONE.JS SETUP ---
        let sampler;
        let canPlay = false; 

        function setupAudio() {
            sampler = new Tone.Sampler({
                urls: { C4: "C4.mp3" },
                baseUrl: "https://tonejs.github.io/audio/salamander/",
            }).toDestination();
            sampler.volume.value = 0; 
        }

        // Whimsical Chime Sound
        function playRevealChime() {
            if (sampler) {
                sampler.triggerAttackRelease("E5", "8n"); 
                sampler.triggerAttackRelease("G5", "8n", "+0.1"); 
                sampler.triggerAttackRelease("C6", "4n", "+0.2");
            }
        }

        // --- DATA FILLING & SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        
        // 1. Get Gift Code
        const giftCodeParam = urlParams.get('code') || "GIFT-CODE-MISSING";
        
        // 2. Get Detail Message (NEW PARAMETER)
        const detailMsgParam = urlParams.get('detmsg'); 

        // 3. Set the code display (starts hidden)
        document.getElementById('gift-code-display').innerText = giftCodeParam;
        document.getElementById('gift-code-display').style.display = 'none';
        document.getElementById('copy-gift-btn').style.display = 'none';
        
        // 4. Set Detail Message if present
        const detailMessageBox = document.getElementById('detail-message-box');
        if (detailMsgParam) {
            detailMessageBox.innerHTML = `<p style="font-style:italic;">"${detailMsgParam}"</p>`;
        }


        // --- CANVAS SETUP ---
        const canvas = document.getElementById('scratchCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.querySelector('.card-container');
        const confettiContainer = document.getElementById('confetti-container');
        const dpr = window.devicePixelRatio || 1;

        // Set canvas size to match the CONTAINER (fixes the sizing issue)
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr); canvas.style.width = `${rect.width}px`; canvas.style.height = `${rect.height}px`;

        let isComplete = false;
        
        // --- DRAW GREEN CASH FOIL (Money/Cash Theme remains for functionality) ---
        function drawFoil() {
            const gradient = ctx.createLinearGradient(0, 0, rect.width, rect.height);
            // Green/Cash Gradient
            gradient.addColorStop(0, '#38A169'); gradient.addColorStop(0.3, '#68D391'); gradient.addColorStop(0.6, '#38A169'); gradient.addColorStop(1, '#68D391'); 
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, rect.width, rect.height);
            
            // White Dollar Sign Sparkles
            for (let i = 0; i < 200; i++) { 
                ctx.fillStyle = `rgba(255,255,255, ${Math.random() * 0.4 + 0.3})`; 
                ctx.font = "16px sans-serif";
                ctx.fillText("$", Math.random() * rect.width, Math.random() * rect.height);
            }
            
            ctx.fillStyle = "rgba(0,0,0,0.8)"; // Black scratch text for high contrast
            ctx.font = "700 20px 'Inter'"; 
            ctx.textAlign = "center"; 
            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 5; 
            // Use the Title parameter for the foil text
            ctx.fillText(urlParams.get('title') || "SCRATCH FOR YOUR GIFT!", rect.width/2, rect.height/2 + 5);
        }
        drawFoil();

        // --- COPY FUNCTION FOR GIFT CODE ---
        function copyGiftCode() { 
            const codeText = document.getElementById("gift-code-display").innerText; 
            
            const textArea = document.createElement("textarea");
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            document.getElementById("copy-gift-btn").innerText = 'Code Copied!';
            setTimeout(() => {
                document.getElementById("copy-gift-btn").innerText = 'Copy Code';
            }, 1500);
        }
        window.copyGiftCode = copyGiftCode; // Expose globally for button click

        // --- ANIMATION / REVEAL ---
        function runAnimation() {
            if (isComplete) return;
            isComplete = true; 
            playRevealChime(); 
            
            // Show the gift code and button
            document.getElementById('gift-code-display').style.display = 'block';
            document.getElementById('copy-gift-btn').style.display = 'block';
            document.querySelector('.instructions').innerText = 'Code revealed! Tap copy.';


            const burst = document.createElement('div');
            burst.className = 'burst-effect';
            container.appendChild(burst);

            for (let i = 0; i < 50; i++) {
                const petal = document.createElement('div');
                petal.className = 'petal';
                petal.style.left = `${Math.random() * 100}%`;
                petal.style.top = `${-10 - Math.random() * 20}px`; 
                petal.style.width = `${4 + Math.random() * 6}px`;
                petal.style.height = `${4 + Math.random() * 6}px`;
                petal.style.animationDuration = `${1.5 + Math.random() * 1.5}s`;
                petal.style.animationDelay = `${Math.random() * 0.5}s`;
                petal.style.animationName = 'fall';
                confettiContainer.appendChild(petal);
            }

            confettiContainer.style.opacity = 1;
            canvas.style.opacity = 0; 

            setTimeout(() => {
                confettiContainer.innerHTML = '';
                if (burst && burst.parentNode) burst.parentNode.removeChild(burst);
            }, 3000);
        }
        
        // --- CHECK LOGIC (UNCHANGED) ---
        function checkScratchCompletionOnLift() {
            if (isComplete) return; 
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            let currentScratched = 0;
            const checkDensity = 20; 
            const totalCheckablePixels = (canvas.width * canvas.height) / checkDensity;
            for (let i = 3; i < pixels.length; i += 4 * checkDensity) {
                if (pixels[i] === 0) { currentScratched++; }
            }
            const scratchPercentage = (currentScratched / totalCheckablePixels) * 100;
            if (scratchPercentage >= 50) { runAnimation(); }
        }
        
        // --- SCRATCH MECHANIC ---
        let isDrawing = false;

        // Helper to get coordinates relative to the card container
        function getRelativeCoords(e) {
            const containerRect = container.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return {
                x: clientX - containerRect.left,
                y: clientY - containerRect.top
            };
        }

        function scratch(x, y) { 
            ctx.globalCompositeOperation = 'destination-out'; 
            ctx.beginPath(); 
            const angle = Math.random() * Math.PI * 2; 
            const radius = 40; 
            ctx.ellipse(x, y, radius, radius * 0.8, angle, 0, Math.PI * 2); 
            ctx.fill(); 
        }

        document.addEventListener('touchstart', initializeAudioContext, { once: true });
        document.addEventListener('mousedown', initializeAudioContext, { once: true });
        
        function initializeAudioContext() {
            Tone.start().then(() => { setupAudio(); canPlay = true; });
        }

        canvas.addEventListener('mousedown', (e) => { 
            const { x, y } = getRelativeCoords(e);
            scratch(x, y);
            isDrawing = true; 
        }); 

        canvas.addEventListener('mouseup', (e) => { 
            isDrawing = false; 
            checkScratchCompletionOnLift(); 
        });

        canvas.addEventListener('mousemove', (e) => { 
            if (isDrawing) { 
                const { x, y } = getRelativeCoords(e);
                scratch(x, y);
            } 
        });

        canvas.addEventListener('touchstart', (e) => { 
            const { x, y } = getRelativeCoords(e);
            scratch(x, y);
            isDrawing = true; 
        }, {passive: false}); 

        canvas.addEventListener('touchend', (e) => { 
            isDrawing = false; 
            checkScratchCompletionOnLift(); 
        
        });

        canvas.addEventListener('touchmove', (e) => { 
            if (isDrawing) { 
                const { x, y } = getRelativeCoords(e);
                scratch(x, y);
            } 
        }, {passive: false});
    </script>
</body>
</html>
