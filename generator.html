<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Gift Link | Jega Digital</title>
    <!-- Open Graph Data -->
    <meta property="og:title" content="Jega Digital Generator">
    <meta property="og:image" content="https://images.unsplash.com/photo-1605218427306-635ba2439af2?q=80&w=600&auto=format&fit=crop">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f8f5f2; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; color: #333; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; margin: 20px 0; position: relative; }
        label { display: flex; justify-content: space-between; align-items: center; text-align: left; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; color: #888; letter-spacing: 1px; }
        input, select { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: #333; }
        button.primary-btn { background-color: #333; color: white; border: none; padding: 15px; font-size: 16px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: background 0.3s; }
        button.primary-btn:hover { background-color: #000; }
        #app-interface, #expired-screen { display: none; } 
        /* DEBUGGING STYLE: Make error large and prominent */
        .error { color: #d9534f; font-size: 18px; font-weight: bold; margin-top: 15px; margin-bottom: 15px; display: none; padding: 10px; border: 1px solid #d9534f; border-radius: 5px; }

        /* Style for the clickable link success message */
        .success-link {
            text-decoration: none; /* Remove underline */
            word-break: break-all; /* Allow long link to wrap */
            font-size: 14px;
            color: #333;
            background-color: #d8ffda; /* Light green background */
            padding: 10px;
            border-radius: 5px;
            display: block;
            margin-top: 5px;
        }

        /* Sign Out Styles */
        .signout-btn {
            position: absolute; top: 10px; right: 10px; 
            background: none; border: none; font-size: 10px; 
            color: #ccc; cursor: pointer; padding: 5px;
        }
        .signout-btn:hover { color: #888; }
        
        /* Gift Code Input Specific Style */
        #giftCodeContainer { margin-bottom: 20px; border: 2px solid #10B981; padding: 15px; border-radius: 10px; background: #e6fff4; display: none; }
        
        /* Message Field Styling */
        #cardMessageContainer { margin-bottom: 20px; }
    </style>
</head>
<body>

    <!-- SCREEN 1: LOGIN -->
    <div class="container" id="login-screen">
        <h1>ðŸ”’ Restricted Access</h1>
        <p>Enter the Access Code found in your Etsy download.</p>
        <input type="password" id="accessCode" placeholder="Enter Access Code">
        <!-- Error message now placed centrally -->
        <p class="error" id="loginError">Invalid Code.</p>
        <button class="primary-btn" onclick="checkPass()">Unlock Tool</button>
    </div>

    <!-- SCREEN 2: EXPIRED -->
    <div class="container" id="expired-screen">
        <h1 style="color: #d9534f;">ðŸš« Access Expired</h1>
        <p>Your 30-day access has ended.</p>
        <a href="https://www.etsy.com/shop/YourShopName" target="_blank"><button class="primary-btn">Buy New Pass</button></a>
    </div>

    <!-- SCREEN 3: THE TOOL -->
    <div class="container" id="app-interface">
        <!-- New Sign Out Button -->
        <button class="signout-btn" onclick="signOut()">Sign Out</button>

        <h1>âœ¨ Create Invitation</h1>
        <p style="margin-bottom: 30px; color:#666;">Fill in the details for your card.</p>
        
        <!-- TOP TITLE FIELD (Kept separate) -->
        <label>Top Title (Optional)</label>
        <input type="text" id="cardTitle" placeholder="e.g. Happy Birthday!">
        
        <!-- GIFT CODE INPUT -->
        <div id="giftCodeContainer">
            <label for="giftCodeInput" style="color: #10B981;">Gift Card Code (Required for this Card)</label>
            <input type="text" id="giftCodeInput" placeholder="e.g. AMAZON-X93B or 'Gift sent via PayPal'">
        </div>
        <!-- END GIFT CODE INPUT -->

        <!-- DETAILED MESSAGE CONTAINER (ALWAYS VISIBLE for all cards) -->
        <div id="cardMessageContainer">
            <label id="cardMessageLabel">Detailed Message (Required for Invitation Cards)</label> <!-- Changed label text -->
            <input type="text" id="cardMessage" placeholder="Hope you like this gift! Love, Sarah.">
        </div>
        <!-- END DETAILED MESSAGE CONTAINER -->
        
        <!-- DYNAMIC FIELDS CONTAINER (HIDES DATE/TIME/LOCATION for money card) -->
        <div id="dynamicFields">
            <!-- These are the traditional fields -->
            <label>Date (Optional)</label>
            <input type="text" id="cardDate" placeholder="e.g. October 26th, 2025">

            <label>Time (Optional)</label>
            <input type="text" id="cardTime" placeholder="e.g. 4:00 PM">

            <label>Location (Optional)</label>
            <input type="text" id="cardLoc" placeholder="e.g. The Plaza Hotel, NYC">
        </div>

        <button class="primary-btn" onclick="generateLink()">Create Magic Link</button>

        <!-- The linkGenerationError element is now used for both login errors and link generation errors -->
        <p class="error" id="linkGenerationError">.</p>
    </div>

    <script>
        // --- Jega Digital Product Codes & Security Configuration ---
        const CODES = {
            'GOLD2025': { file: 'card.html', theme: 'Gold Floral', active: true },
            'PURPLE2025': { file: 'card-purple.html', theme: 'Purple Floral', active: true },
            'NAVY2025': { file: 'card-navy.html', theme: 'Navy Luxury', active: true },
            'MEME2025': { file: 'card-67.html', theme: '67 Meme Card (Original)', active: true },
            'SANTA2025': { file: 'card-santa.html', theme: 'Santa 67 Meme', active: true },
            // Gift Card Product 1 (Money Meme)
            '67MEME': { file: '67-meme.html', theme: 'Money 67 Hybrid', active: true, requiresCode: true, noExpiry: true }, 
            // NEW: Gift Card Product 2 (Gaming Loot Drop)
            'CYBERLOOT': { file: 'gaming-card.html', theme: 'Cyber Loot Drop', active: true, requiresCode: true, noExpiry: true } 
        };
        const ACCESS_DAYS = 30;
        
        const errorDisplay = document.getElementById("loginError");
        const linkErrorDisplay = document.getElementById("linkGenerationError");

        // Helper to display errors clearly
        function displayError(message, isSuccess = false) {
            linkErrorDisplay.innerHTML = message; // Use innerHTML to allow link insertion
            linkErrorDisplay.style.display = "block";
            linkErrorDisplay.style.color = isSuccess ? 'green' : '#d9534f'; // Use inline color property, not class
            linkErrorDisplay.style.borderColor = isSuccess ? '#38A169' : '#d9534f';
            // Also ensure the error box is reset to its default error look if successful (it will hold the link element)
            linkErrorDisplay.classList.remove('success-link'); 
            linkErrorDisplay.style.fontSize = isSuccess ? '16px' : '18px';
            linkErrorDisplay.style.padding = isSuccess ? '0' : '10px';
            linkErrorDisplay.style.border = isSuccess ? 'none' : '1px solid #d9534f';
            linkErrorDisplay.style.backgroundColor = isSuccess ? 'transparent' : 'white';
        }

        // Load API key and check login status on load
        window.onload = function() { 
            if (!checkExpiry()) return;
            if (localStorage.getItem('jega_access_granted') === 'true') {
                showAppInterface();
            }
        };

        // --- SIGN OUT FUNCTION ---
        function signOut() {
            // 1. Clear all authentication and product data
            localStorage.removeItem('jega_start_date');
            localStorage.removeItem('jega_access_granted');
            localStorage.removeItem('jega_card_file');
            
            // 2. Clear any lingering form data
            document.getElementById('accessCode').value = '';
            
            // 3. Clear the residual success/error message
            linkErrorDisplay.innerText = "";
            linkErrorDisplay.style.display = "none";
            
            // 4. Reset interface to login screen
            document.getElementById("login-screen").style.display = "block"; 
            document.getElementById("app-interface").style.display = "none"; 
            
            console.log("User successfully signed out.");
        }
        
        function showAppInterface() {
            document.getElementById("login-screen").style.display = "none"; 
            document.getElementById("app-interface").style.display = "block"; 
            checkExpiry(); 
            checkCardRequirement();
        }

        // Checks which fields should be visible based on the card type
        function checkCardRequirement() {
            const cardFile = localStorage.getItem('jega_card_file');
            const codeContainer = document.getElementById('giftCodeContainer');
            const dynamicFields = document.getElementById('dynamicFields'); // Container for Date/Time/Loc
            const messageLabel = document.getElementById('cardMessageLabel');
            
            const currentCode = Object.values(CODES).find(c => c.file === cardFile);
            
            if (currentCode) {
                // Determine if it's a gift card type (hides date/time/loc, requires code)
                const isGiftCardType = currentCode.file === '67-meme.html' || currentCode.file === 'gaming-card.html';

                // Control Gift Code Input visibility
                if (currentCode.requiresCode) {
                    codeContainer.style.display = 'block';
                } else {
                    codeContainer.style.display = 'none';
                }

                // Control General Input Fields (Date/Time/Loc)
                if (isGiftCardType) {
                    dynamicFields.style.display = 'none';
                    messageLabel.innerText = "Detailed Message (Optional)"; // Gift card type: Message is optional
                } else {
                    dynamicFields.style.display = 'block';
                    messageLabel.innerText = "Detailed Message (Required for Invitation Cards)"; // Invitation card type: Message is mandatory
                }
                
                // Control Timer display (REMOVED TIMER DISPLAY)
            }
        }

        function checkExpiry() {
            const firstLogin = localStorage.getItem('jega_start_date');
            const cardFile = localStorage.getItem('jega_card_file');
            const currentCode = Object.values(CODES).find(c => c.file === cardFile);

            // If the current product has no expiry, skip the check
            if (currentCode && currentCode.noExpiry) {
                 return true;
            }
            
            if (firstLogin) {
                const now = new Date().getTime(); 
                const diffDays = (now - parseInt(firstLogin)) / (1000 * 60 * 60 * 24);
                if (diffDays > ACCESS_DAYS) { 
                    document.getElementById("login-screen").style.display = "none"; 
                    document.getElementById("app-interface").style.display = "none"; 
                    document.getElementById("expired-screen").style.display = "block"; 
                    localStorage.removeItem('jega_access_granted'); 
                    localStorage.removeItem('jega_card_file'); 
                    return false; 
                } else { 
                    return true; 
                }
            } 
            return true; 
        }

        function checkPass() {
            if (!checkExpiry()) return; 
            const input = document.getElementById("accessCode").value.toUpperCase();
            
            const selectedCode = CODES[input];

            if (selectedCode && selectedCode.active) { 
                
                // If product requires expiry, set the start date. Otherwise, skip.
                if (!selectedCode.noExpiry && !localStorage.getItem('jega_start_date')) {
                    localStorage.setItem('jega_start_date', new Date().getTime());
                } else if (selectedCode.noExpiry) {
                    // For non-expiring products, ensure old start date is removed if a customer switches
                    localStorage.removeItem('jega_start_date');
                }
                
                localStorage.setItem('jega_card_file', selectedCode.file);
                localStorage.setItem('jega_access_granted', 'true');
                
                showAppInterface();
            } else { 
                errorDisplay.innerText = "Invalid Code.";
                errorDisplay.style.display = "block"; 
            }
        }

        function generateLink() {
            // Clear previous errors/success messages
            linkErrorDisplay.style.display = "none";

            try {
                // Fetch form values safely
                const title = document.getElementById("cardTitle").value;
                const detmsg = document.getElementById("cardMessage").value; 
                const date = document.getElementById("cardDate").value;
                const time = document.getElementById("cardTime").value;
                const loc = document.getElementById("cardLoc").value;
                
                const cardFile = localStorage.getItem('jega_card_file') || 'card.html'; 
                const currentCode = Object.values(CODES).find(c => c.file === cardFile);
                
                // 1. Check if the card is a gift card type (67MEME or CYBERLOOT)
                const isGiftCardType = currentCode.file === '67-meme.html' || currentCode.file === 'gaming-card.html';

                // --- VALIDATION AND LINK ASSEMBLY ---

                // 2. Gift Code Check (Required for meme/gaming cards)
                let giftCode = '';
                if (currentCode && currentCode.requiresCode) {
                    giftCode = document.getElementById('giftCodeInput').value;
                    if (!giftCode) {
                        displayError("ERROR: You must enter the required Gift Card Code!");
                        return;
                    }
                }
                
                // 3. Message Check (Required for non-gift card types)
                if (!isGiftCardType && !detmsg) {
                     displayError("ERROR: Please enter the Detailed Message for this invitation card.");
                     return;
                }

                const baseUrl = window.location.origin + "/" + cardFile; 
                let finalUrl = baseUrl + '?'; // Start base URL assembly

                // 4. Assemble parameters specific to the card type

                if (isGiftCardType) {
                    // --- Gift Card Types (67MEME, CYBERLOOT) ---
                    
                    if (currentCode.file === '67-meme.html') {
                        // 67 Meme Card requires 'msg=67' for the design to work
                        finalUrl += `msg=67`; 
                    } 
                    // Note: Gaming card does not require a base 'msg' parameter

                    // Handle Secondary/Custom Message Field (detmsg input):
                    if (detmsg) {
                        if (currentCode.file === '67-meme.html') {
                            finalUrl += `&detmsg=${encodeURIComponent(detmsg)}`; // Old meme card uses detmsg
                        } else if (currentCode.file === 'gaming-card.html') {
                            finalUrl += `message=${encodeURIComponent(detmsg)}`; // New gaming card uses 'message'
                        }
                    }

                } else {
                    // --- Invitation Card Types (Floral, Navy, Santa) ---
                    
                    // Primary Message (detmsg input goes to 'msg' parameter)
                    finalUrl += `msg=${encodeURIComponent(detmsg)}`;

                    // Date/Time/Loc
                    if (date) finalUrl += `&date=${encodeURIComponent(date)}`;
                    if (time) finalUrl += `&time=${encodeURIComponent(time)}`;
                    if (loc) finalUrl += `&loc=${encodeURIComponent(loc)}`;
                }

                // 5. Common parameters (Title and Gift Code)
                if (title) finalUrl += `&title=${encodeURIComponent(title)}`;
                if (giftCode) finalUrl += `&code=${encodeURIComponent(giftCode)}`;
                
                // Final cleanup: remove trailing '?' if no params were added (only necessary if multiple optional params are used, but good practice)
                if (finalUrl.endsWith('?')) {
                    finalUrl = finalUrl.slice(0, -1);
                }
                // Also clean up any leading '&' if the first parameter was optional and skipped
                if (finalUrl.includes('?&')) {
                    finalUrl = finalUrl.replace('?&', '?');
                }

                // --- LINK OUTPUT AND COPY ---
                
                const textArea = document.createElement("textarea");
                textArea.value = finalUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                // FIX: Display the actual link as a clickable element in the success box
                const successMessage = `
                    SUCCESS! Magic Link Copied to Clipboard.
                    <a href="${finalUrl}" target="_blank" class="success-link">Click to View Card: ${finalUrl}</a>
                `;
                displayError(successMessage, true);
                
                console.log("Magic Link Generated and Copied: " + finalUrl);

            } catch (e) {
                // CATCH CRASH: This will show if the script fails before validation
                console.error("Critical error during link generation:", e);
                displayError("CRITICAL ERROR: Failed to assemble link. Try signing out and signing back in. (Check console for details)");
            }
        }
        
    </script>
</body>
</html>
