<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Gift Link | Jega Digital</title>
    <!-- Open Graph Data -->
    <meta property="og:title" content="Jega Digital Generator">
    <meta property="og:image" content="https://images.unsplash.com/photo-1605218427306-635ba2439af2?q=80&w=600&auto=format&fit=crop">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f8f5f2; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; color: #333; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; margin: 20px 0; position: relative; }
        label { display: flex; justify-content: space-between; align-items: center; text-align: left; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; color: #888; letter-spacing: 1px; }
        input, select { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: #333; }
        button.primary-btn { background-color: #333; color: white; border: none; padding: 15px; font-size: 16px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: background 0.3s; }
        button.primary-btn:hover { background-color: #000; }
        #app-interface, #expired-screen { display: none; } 
        .error { color: #d9534f; font-size: 14px; margin-bottom: 15px; display: none; }
        .result-box { margin-top: 30px; display: none; background: #f0f0f0; padding: 20px; border-radius: 10px; text-align: left; }
        .result-link { word-break: break-all; color: #555; font-size: 14px; margin-bottom: 10px; display: block; }
        .timer-text { margin-top: 20px; font-size: 12px; color: #ccc; }

        /* AI Features Styles */
        .ai-trigger { cursor: pointer; color: #d4af37; display: flex; align-items: center; gap: 5px; transition: color 0.3s; }
        .ai-trigger:hover { color: #b8962e; }
        
        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: left; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .ai-option { background: #f9f9f9; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .ai-option:hover { border-color: #d4af37; background: #fffcf5; }
        .loading-spinner { display: none; text-align: center; color: #888; font-size: 14px; margin: 20px 0; }
        .close-btn { background: #eee; color: #333; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

    <!-- SCREEN 1: LOGIN -->
    <div class="container" id="login-screen">
        <h1>ðŸ”’ Restricted Access</h1>
        <p>Enter the Access Code found in your Etsy download.</p>
        <input type="password" id="accessCode" placeholder="Enter Access Code">
        <p class="error" id="loginError">Invalid Code.</p>
        <button class="primary-btn" onclick="checkPass()">Unlock Tool</button>
    </div>

    <!-- SCREEN 2: EXPIRED -->
    <div class="container" id="expired-screen">
        <h1 style="color: #d9534f;">ðŸš« Access Expired</h1>
        <p>Your 30-day access has ended.</p>
        <a href="https://www.etsy.com/shop/YourShopName" target="_blank"><button class="primary-btn">Buy New Pass</button></a>
    </div>

    <!-- SCREEN 3: THE TOOL -->
    <div class="container" id="app-interface">
        <h1>âœ¨ Create Invitation</h1>
        <p style="margin-bottom: 30px; color:#666;">Fill in the details for your card.</p>
        
        <label>Top Title (Optional)</label>
        <input type="text" id="cardTitle" placeholder="e.g. Save the Date">

        <!-- AI TRIGGER BUTTON ADDED HERE -->
        <label>
            Main Message (Required) 
            <span class="ai-trigger" onclick="openAIModal()">âœ¨ AI Help</span>
        </label>
        <input type="text" id="cardMessage" placeholder="e.g. We are getting married!">

        <label>Date (Optional)</label>
        <input type="text" id="cardDate" placeholder="e.g. October 26th, 2025">

        <label>Time (Optional)</label>
        <input type="text" id="cardTime" placeholder="e.g. 4:00 PM">

        <label>Location (Optional)</label>
        <input type="text" id="cardLoc" placeholder="e.g. The Plaza Hotel, NYC">

        <button class="primary-btn" onclick="generateLink()">Create Magic Link</button>

        <div id="resultArea" class="result-box">
            <span style="font-size:12px; font-weight:bold; color:#888; text-transform:uppercase;">Your Unique Link:</span>
            <a id="finalLink" class="result-link" href="#" target="_blank"></a>
            <button style="background:white; color:#333; border:1px solid #ddd; padding:10px; width:100%; border-radius:5px; cursor:pointer;" onclick="copyToClipboard()">Copy to Clipboard</button>
        </div>
        <p class="timer-text" id="days-remaining"></p>
    </div>

    <!-- AI MODAL -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal-content">
            <div class="modal-title">âœ¨ AI Wedding Poet</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">I'll write the message for you. Just tell me the vibe.</p>
            
            <label style="margin-bottom:5px;">Couple's Names</label>
            <input type="text" id="aiNames" placeholder="e.g. Jack & Rose" style="margin-bottom: 10px;">
            
            <label style="margin-bottom:5px;">Vibe</label>
            <select id="aiVibe" style="margin-bottom: 15px;">
                <option value="Romantic">Romantic & Sweet</option>
                <option value="Formal">Formal & Elegant</option>
                <option value="Witty">Witty & Fun</option>
                <option value="Minimalist">Minimalist</option>
            </select>

            <label style="margin-bottom:5px;">Gemini API Key (Optional)</label>
            <input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key here" style="margin-bottom: 15px; font-size: 12px;">

            <button class="primary-btn" onclick="generateAIContent()" style="padding: 10px; font-size: 14px;">Generate Options</button>
            
            <div class="loading-spinner" id="aiLoading">âœ¨ Dreaming up words...</div>
            <div id="aiResults" style="margin-top: 15px;"></div>

            <button class="close-btn" onclick="closeAIModal()">Cancel</button>
        </div>
    </div>

    <script>
        // --- Jega Digital Product Codes & Security Configuration ---
        const CODES = {
            'GOLD2025': { file: 'card.html', theme: 'Gold Floral', active: true },
            'PURPLE2025': { file: 'card-purple.html', theme: 'Purple Floral', active: true },
            'NAVY2025': { file: 'card-navy.html', theme: 'Navy Luxury', active: true }
        };
        const ACCESS_DAYS = 30;
        
        // Load API Key from local storage if available
        window.onload = function() { 
            if (!checkExpiry()) return;
            if (localStorage.getItem('jega_access_granted') === 'true') {
                showAppInterface();
            }
            // Pre-fill API key if user saved it before
            const savedKey = localStorage.getItem('jega_gemini_key');
            if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
        };

        function showAppInterface() {
            document.getElementById("login-screen").style.display = "none"; 
            document.getElementById("app-interface").style.display = "block"; 
            checkExpiry(); 
        }

        function checkExpiry() {
            const firstLogin = localStorage.getItem('jega_start_date');
            if (firstLogin) {
                const now = new Date().getTime(); 
                const diffDays = (now - parseInt(firstLogin)) / (1000 * 60 * 60 * 24);
                if (diffDays > ACCESS_DAYS) { 
                    document.getElementById("login-screen").style.display = "none"; 
                    document.getElementById("app-interface").style.display = "none"; 
                    document.getElementById("expired-screen").style.display = "block"; 
                    localStorage.removeItem('jega_access_granted'); 
                    localStorage.removeItem('jega_card_file'); 
                    return false; 
                } else { 
                    document.getElementById("days-remaining").innerText = "License active: " + Math.ceil(ACCESS_DAYS - diffDays) + " days remaining."; 
                    return true; 
                }
            } 
            return true; 
        }

        function checkPass() {
            if (!checkExpiry()) return; 
            const input = document.getElementById("accessCode").value.toUpperCase();
            
            // 1. Check if the input code is in the CODES list
            if (CODES[input] && CODES[input].active) { 
                // 2. Access is valid: Set start date (if new) and grant access
                if (!localStorage.getItem('jega_start_date')) {
                    localStorage.setItem('jega_start_date', new Date().getTime());
                }
                
                // 3. Store the specific card file the user bought
                localStorage.setItem('jega_card_file', CODES[input].file);
                localStorage.setItem('jega_access_granted', 'true');
                
                showAppInterface();
            } else { 
                document.getElementById("loginError").style.display = "block"; 
            }
        }

        function generateLink() {
            const title = document.getElementById("cardTitle").value;
            const msg = document.getElementById("cardMessage").value;
            const date = document.getElementById("cardDate").value;
            const time = document.getElementById("cardTime").value;
            const loc = document.getElementById("cardLoc").value;
            
            if (!msg) { alert("Please enter a main message!"); return; }

            // Get the correct file name based on the purchased code (defaults to card.html)
            const cardFile = localStorage.getItem('jega_card_file') || 'card.html'; 

            // Construct the Base URL using the correct card file
            const baseUrl = window.location.origin + "/" + cardFile; 
            let finalUrl = `${baseUrl}?msg=${encodeURIComponent(msg)}`;

            if (title) finalUrl += `&title=${encodeURIComponent(title)}`;
            if (date) finalUrl += `&date=${encodeURIComponent(date)}`;
            if (time) finalUrl += `&time=${encodeURIComponent(time)}`;
            if (loc) finalUrl += `&loc=${encodeURIComponent(loc)}`;

            const linkDisplay = document.getElementById("finalLink");
            linkDisplay.innerText = finalUrl;
            linkDisplay.href = finalUrl;
            document.getElementById("resultArea").style.display = "block";
        }

        function copyToClipboard() { 
            const linkText = document.getElementById("finalLink").innerText; 
            // Fallback for iframe/security context where navigator might fail
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(linkText).then(() => alert("Link Copied!"));
            } else {
                // Older method as fallback
                const textArea = document.createElement("textarea");
                textArea.value = linkText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert("Link Copied!");
            }
        }

        // --- GEMINI AI FEATURES ---
        function openAIModal() {
            document.getElementById('aiModal').style.display = 'flex';
        }

        function closeAIModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        async function generateAIContent() {
            const names = document.getElementById('aiNames').value;
            const vibe = document.getElementById('aiVibe').value;
            const apiKey = document.getElementById('apiKeyInput').value;
            
            if (!apiKey) { alert("Please enter a Gemini API Key."); return; }
            
            // Save Key for next time
            localStorage.setItem('jega_gemini_key', apiKey);

            document.getElementById('aiLoading').style.display = 'block';
            document.getElementById('aiResults').innerHTML = '';

            const prompt = `Write 3 distinct, creative wedding invitation one-liners for a couple named ${names || 'us'}. Tone: ${vibe}. Max 15 words each. Do not use quotes.`;

            // Function for exponential backoff retry logic
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!response.ok) {
                        // Throw error to trigger retry if status is not OK
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        // Successfully received response
                        const options = text.split(/\n/).filter(line => line.trim().length > 5);
                        let html = '';
                        options.slice(0, 3).forEach(opt => {
                            const cleanText = opt.replace(/^\d+\.\s*/, '').replace(/[*"]/g, '');
                            html += `<div class="ai-option" onclick="selectAIOption('${cleanText.replace(/'/g, "\\'")}')">${cleanText}</div>`;
                        });
                        document.getElementById('aiResults').innerHTML = html;
                        return; // Exit function on success
                    } else {
                        // Log empty response and continue to next attempt or exit
                        throw new Error("Empty response received from API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed.`, error);
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000; // Exponential backoff: 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        alert("Error calling Gemini API after multiple retries. Check console.");
                    }
                }
            } 
        }

        function selectAIOption(text) {
            document.getElementById('cardMessage').value = text;
            closeAIModal();
        }
    </script>
</body>
</html>
