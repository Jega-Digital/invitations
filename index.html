<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PressOn Pro</title>
    <style>
        :root {
            --primary: #ff4081;     /* Pink for Nails */
            --secondary: #00e676;   /* Green for Calibration */
            --dark: #121212;
            --panel: #1e1e1e;
            --text: #ffffff;
            --accent: #2979ff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- VIEWS --- */
        .view {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .view.active {
            display: flex;
        }

        /* --- INTRO SCREEN --- */
        #intro-view {
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #1e1e1e 0%, #000000 100%);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: -webkit-linear-gradient(0deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .instructions {
            color: #aaa;
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 0.9rem;
            text-align: left;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-top: 20px;
        }

        .btn-main {
            border: 2px solid var(--primary);
            color: white;
            background-color: transparent;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(255, 64, 129, 0.3);
        }

        .btn-main:active {
            background-color: var(--primary);
            transform: scale(0.95);
        }

        #file-input {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
        }

        /* --- WORKSPACE --- */
        #workspace-container {
            flex-grow: 1;
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #zoom-layer {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center center;
        }

        #image-layer {
            max-width: 100%;
            max-height: 100%;
            pointer-events: none;
            display: block;
        }

        /* The Selection Tool */
        #selection-tool {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            border: 2px solid white;
            box-shadow: 0 0 0 10000px rgba(0, 0, 0, 0.6);
            z-index: 10;
            cursor: grab;
            pointer-events: auto;
            touch-action: none;
        }

        #selection-tool:active {
            cursor: grabbing;
            border-color: #fff !important;
        }

        .mode-calibrate #selection-tool {
            border-color: var(--secondary);
            border-radius: 2px;
        }

        .mode-measure #selection-tool {
            border-color: var(--primary);
            border-radius: 50%;
        }

        #selection-tool::after, #selection-tool::before {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.5);
            pointer-events: none;
        }
        #selection-tool::after { top: 50%; left: 0; right: 0; height: 1px; }
        #selection-tool::before { left: 50%; top: 0; bottom: 0; width: 1px; }

        /* --- HUD --- */
        #hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }
        #hud > * { pointer-events: auto; }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #000;
            font-weight: bold;
            margin-right: 8px;
        }
        .badge-cal { background: var(--secondary); }
        .badge-mea { background: var(--primary); }

        .zoom-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .magic-btn {
            background: linear-gradient(135deg, #6200ea, #b388ff);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: width 0.3s;
        }

        /* --- CONTROLS --- */
        #controls-panel {
            background: var(--panel);
            padding: 10px 10px 20px 10px;
            z-index: 30;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .d-pad-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 6px;
            flex-grow: 1;
            max-width: 200px;
            margin: 0 auto;
        }

        .btn-ctrl {
            background: #333;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.2rem;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }
        
        .btn-ctrl:active { background: #555; transform: scale(0.96); }

        .btn-next {
            background: var(--primary);
            color: white;
            font-weight: bold;
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            margin-top: 5px;
            font-size: 1.1rem;
        }

        .label-text {
            font-size: 0.7rem;
            color: #888;
            text-align: center;
            margin-bottom: 2px;
        }

        /* --- DASHBOARD --- */
        #dashboard-view { padding: 20px; background: var(--dark); }
        .result-card {
            background: var(--panel);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
        }
        .result-finger { font-weight: bold; color: #fff; }
        .result-value { color: var(--primary); font-family: monospace; font-size: 1.2rem; }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <!-- VIEW 1: INTRO / UPLOAD -->
    <div id="intro-view" class="view active">
        <h1>PressOn Pro</h1>
        <p style="color:#888; margin-top: -10px;">Precision Remote Sizing</p>
        <div class="instructions">
            <strong>Ready to Measure?</strong>
            <ul style="padding-left: 20px; margin-top: 10px;">
                <li>üì∏ <strong>Upload</strong> a clear photo.</li>
                <li>üëÜ <strong>Drag</strong> the box to fit.</li>
                <li>ü§ñ <strong>Magic Fit</strong> will auto-center for you.</li>
            </ul>
        </div>
        <div class="upload-btn-wrapper">
            <button class="btn-main">üì∏ Upload Photo</button>
            <input type="file" id="file-input" accept="image/*">
        </div>
    </div>

    <!-- VIEW 2: WORKSPACE -->
    <div id="workspace-view" class="view">
        <div id="hud">
            <div>
                <span id="step-badge" class="badge badge-cal">STEP 1</span>
                <span id="step-label">Calibration</span>
            </div>
            <div>
                <button id="magic-btn" class="magic-btn" onclick="app.magicFit()">‚ú® Magic Fit</button>
                <button class="zoom-toggle" onclick="app.toggleZoom()">üîç Zoom</button>
            </div>
        </div>

        <div id="workspace-container">
            <div id="zoom-layer">
                <img id="image-layer" src="" alt="User Hand">
                <div id="selection-tool"></div>
            </div>
        </div>

        <div id="controls-panel">
            <div class="control-row">
                <div style="flex:1">
                    <div class="label-text">WIDTH</div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-ctrl" style="flex:1" data-action="w-dec" data-repeat="true">-</button>
                        <button class="btn-ctrl" style="flex:1" data-action="w-inc" data-repeat="true">+</button>
                    </div>
                </div>
                <div style="flex:1">
                    <div class="label-text">HEIGHT</div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-ctrl" style="flex:1" data-action="h-dec" data-repeat="true">-</button>
                        <button class="btn-ctrl" style="flex:1" data-action="h-inc" data-repeat="true">+</button>
                    </div>
                </div>
                <div style="flex:0.6">
                     <div class="label-text">ROT</div>
                     <div style="display:flex; gap:5px;">
                        <button class="btn-ctrl" style="flex:1" data-action="r-cw" data-repeat="true">‚Üª</button>
                     </div>
                </div>
            </div>

            <div class="control-row" style="margin-top:5px;">
                <div class="d-pad-container">
                    <button class="btn-ctrl" style="grid-column: 2" data-action="up" data-repeat="true">‚ñ≤</button>
                    <button class="btn-ctrl" style="grid-column: 1; grid-row: 2" data-action="left" data-repeat="true">‚óÄ</button>
                    <button class="btn-ctrl" style="grid-column: 2; grid-row: 2" data-action="down" data-repeat="true">‚ñº</button>
                    <button class="btn-ctrl" style="grid-column: 3; grid-row: 2" data-action="right" data-repeat="true">‚ñ∂</button>
                </div>
                <div style="flex: 1; display:flex; align-items:flex-end;">
                     <button id="next-btn" class="btn-next">CONFIRM</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3: DASHBOARD -->
    <div id="dashboard-view" class="view">
        <h2 style="color:white; border-bottom: 1px solid #333; padding-bottom:15px;">Measurement Report</h2>
        <div id="results-container"></div>
        <button class="btn-main" style="width:100%; margin-top:20px;" onclick="location.reload()">Start Over</button>
    </div>

    <script>
        const CONFIG = {
            STANDARD_CARD_WIDTH_MM: 85.60, 
            MOVE_SPEED: 2,
            SIZE_SPEED: 2,
            ROT_SPEED: 1,
            ZOOM_LEVEL: 2.5
        };

        const STEPS = [
            { id: 'cal', label: 'Fit Box to Card', type: 'calibrate', badge: 'CALIB' },
            { id: 'thumb', label: 'Fit to Thumb', type: 'measure', badge: 'THUMB' },
            { id: 'index', label: 'Fit to Index', type: 'measure', badge: 'INDEX' },
            { id: 'middle', label: 'Fit to Middle', type: 'measure', badge: 'MIDDLE' },
            { id: 'ring', label: 'Fit to Ring', type: 'measure', badge: 'RING' },
            { id: 'pinky', label: 'Fit to Pinky', type: 'measure', badge: 'PINKY' }
        ];

        const app = {
            state: {
                stepIndex: 0,
                tool: { x: 0, y: 0, w: 200, h: 120, r: 0 },
                pxPerMm: 0,
                scale: 1,
                measurements: {}
            },
            
            elements: {
                introView: document.getElementById('intro-view'),
                workspaceView: document.getElementById('workspace-view'),
                dashboardView: document.getElementById('dashboard-view'),
                fileInput: document.getElementById('file-input'),
                imageLayer: document.getElementById('image-layer'),
                selectionTool: document.getElementById('selection-tool'),
                stepLabel: document.getElementById('step-label'),
                stepBadge: document.getElementById('step-badge'),
                nextBtn: document.getElementById('next-btn'),
                zoomLayer: document.getElementById('zoom-layer'),
                resultsContainer: document.getElementById('results-container'),
                magicBtn: document.getElementById('magic-btn')
            },

            init() {
                this.elements.fileInput.addEventListener('change', (e) => this.handleImageUpload(e));
                this.elements.nextBtn.addEventListener('click', () => this.handleNextStep());
                this.setupControls();
                this.setupDrag(); 
            },

            handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    this.elements.imageLayer.src = event.target.result;
                    this.elements.imageLayer.onload = () => {
                        this.elements.introView.classList.remove('active');
                        this.elements.workspaceView.classList.add('active');
                        this.loadStep(0);
                    };
                };
                reader.readAsDataURL(file);
            },

            loadStep(index) {
                this.state.stepIndex = index;
                const step = STEPS[index];
                this.elements.stepLabel.innerText = step.label;
                this.elements.stepBadge.innerText = step.badge;
                
                if (step.type === 'calibrate') {
                    document.body.classList.add('mode-calibrate');
                    document.body.classList.remove('mode-measure');
                    this.elements.stepBadge.className = 'badge badge-cal';
                    this.state.tool.w = 200;
                    this.state.tool.h = 126;
                } else {
                    document.body.classList.remove('mode-calibrate');
                    document.body.classList.add('mode-measure');
                    this.elements.stepBadge.className = 'badge badge-mea';
                    this.state.tool.w = 100;
                    this.state.tool.h = 130;
                }
                this.state.tool.r = 0;
                
                // Auto-center on step load (Local logic only)
                this.state.tool.x = 0;
                this.state.tool.y = 0;
                this.renderTool();
            },

            handleNextStep() {
                const step = STEPS[this.state.stepIndex];
                if (step.type === 'calibrate') {
                    const boxWidthPx = this.elements.selectionTool.offsetWidth;
                    this.state.pxPerMm = boxWidthPx / CONFIG.STANDARD_CARD_WIDTH_MM;
                    if (this.state.pxPerMm < 1) { alert("Check calibration."); return; }
                } else {
                    const boxWidthPx = this.elements.selectionTool.offsetWidth;
                    const mm = boxWidthPx / this.state.pxPerMm;
                    this.state.measurements[step.id] = mm.toFixed(1);
                }

                if (this.state.stepIndex < STEPS.length - 1) {
                    this.loadStep(this.state.stepIndex + 1);
                } else {
                    this.showDashboard();
                }
            },

            showDashboard() {
                this.elements.workspaceView.classList.remove('active');
                this.elements.dashboardView.classList.add('active');
                let html = '';
                Object.entries(this.state.measurements).forEach(([key, val]) => {
                    html += `<div class="result-card"><span class="result-finger">${key.toUpperCase()}</span><span class="result-value">${val} mm</span></div>`;
                });
                this.elements.resultsContainer.innerHTML = html;
            },

            setupDrag() {
                const tool = this.elements.selectionTool;
                let startX, startY, initialToolX, initialToolY, isDragging = false;

                const onDragStart = (clientX, clientY) => {
                    isDragging = true;
                    startX = clientX;
                    startY = clientY;
                    initialToolX = this.state.tool.x;
                    initialToolY = this.state.tool.y;
                    tool.style.cursor = 'grabbing';
                };

                const onDragMove = (clientX, clientY) => {
                    if (!isDragging) return;
                    const deltaX = clientX - startX;
                    const deltaY = clientY - startY;
                    this.state.tool.x = initialToolX + (deltaX / this.state.scale);
                    this.state.tool.y = initialToolY + (deltaY / this.state.scale);
                    this.renderTool();
                };

                const onDragEnd = () => {
                    isDragging = false;
                    tool.style.cursor = 'grab';
                };

                tool.addEventListener('mousedown', e => { e.preventDefault(); onDragStart(e.clientX, e.clientY); });
                window.addEventListener('mousemove', e => onDragMove(e.clientX, e.clientY));
                window.addEventListener('mouseup', onDragEnd);
                
                tool.addEventListener('touchstart', e => { 
                    e.preventDefault(); 
                    const t = e.touches[0]; 
                    onDragStart(t.clientX, t.clientY); 
                }, { passive: false });
                
                window.addEventListener('touchmove', e => { 
                    if(isDragging) { 
                        e.preventDefault(); 
                        const t = e.touches[0]; 
                        onDragMove(t.clientX, t.clientY); 
                    } 
                }, { passive: false });
                
                window.addEventListener('touchend', onDragEnd);
            },

            setupControls() {
                const btns = document.querySelectorAll('button[data-action]');
                let interval;
                const start = (action) => {
                    this.performAction(action);
                    clearInterval(interval);
                    interval = setInterval(() => this.performAction(action), 40);
                };
                const stop = () => clearInterval(interval);

                btns.forEach(btn => {
                    const action = btn.dataset.action;
                    btn.addEventListener('touchstart', (e) => { e.preventDefault(); start(action); });
                    btn.addEventListener('touchend', stop);
                    btn.addEventListener('mousedown', (e) => { e.preventDefault(); start(action); });
                    btn.addEventListener('mouseup', stop);
                    btn.addEventListener('mouseleave', stop);
                });
            },

            performAction(action) {
                const t = this.state.tool;
                const speed = CONFIG.MOVE_SPEED / this.state.scale;
                switch(action) {
                    case 'up': t.y -= speed; break;
                    case 'down': t.y += speed; break;
                    case 'left': t.x -= speed; break;
                    case 'right': t.x += speed; break;
                    case 'w-inc': t.w += CONFIG.SIZE_SPEED; break;
                    case 'w-dec': t.w = Math.max(20, t.w - CONFIG.SIZE_SPEED); break;
                    case 'h-inc': t.h += CONFIG.SIZE_SPEED; break;
                    case 'h-dec': t.h = Math.max(20, t.h - CONFIG.SIZE_SPEED); break;
                    case 'r-cw': t.r += CONFIG.ROT_SPEED; break;
                }
                this.renderTool();
            },

            renderTool() {
                const t = this.state.tool;
                const el = this.elements.selectionTool;
                el.style.transform = `translate(calc(-50% + ${t.x}px), calc(-50% + ${t.y}px)) rotate(${t.r}deg)`;
                el.style.width = `${t.w}px`;
                el.style.height = `${t.h}px`;
            },

            toggleZoom() {
                if (this.state.scale === 1) {
                    this.state.scale = CONFIG.ZOOM_LEVEL;
                    this.elements.zoomLayer.style.transform = `scale(${CONFIG.ZOOM_LEVEL})`;
                    this.elements.selectionTool.style.opacity = '0.7'; 
                } else {
                    this.state.scale = 1;
                    this.elements.zoomLayer.style.transform = `scale(1)`;
                    this.elements.selectionTool.style.opacity = '1';
                }
            },

            // --- HYBRID AI / FALLBACK ---
            async magicFit() {
                const btn = this.elements.magicBtn;
                const originalText = btn.innerText;
                btn.innerText = "Thinking...";
                
                // 1. Try Backend
                try {
                    const img = this.elements.imageLayer;
                    // Note: localhost might be blocked in some previews, triggering catch immediately
                    const response = await fetch('http://localhost:5000/detect-nail', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: img.src,
                            finger: STEPS[this.state.stepIndex].id
                        })
                    });
                    
                    if (!response.ok) throw new Error("Server error");
                    
                    const data = await response.json();
                    this.state.tool.x = data.x;
                    this.state.tool.y = data.y;
                    this.state.tool.w = data.w;
                    this.state.tool.h = data.h;
                    this.state.tool.r = data.rotation;
                    this.renderTool();
                    btn.innerText = "‚ú® Found!";
                    
                } catch (error) {
                    console.warn("AI Backend not available. Using Auto-Center.", error);
                    // 2. Fallback: Local Auto-Center
                    this.state.tool.x = 0;
                    this.state.tool.y = 0;
                    this.state.tool.r = 0;
                    
                    // Reset to nice default size based on mode
                    const isCal = STEPS[this.state.stepIndex].type === 'calibrate';
                    this.state.tool.w = isCal ? 200 : 100;
                    this.state.tool.h = isCal ? 126 : 130;
                    
                    this.renderTool();
                    
                    // UI Feedback
                    btn.innerText = "Centered (Offline)";
                } finally {
                    setTimeout(() => btn.innerText = originalText, 1500);
                }
            }
        };

        app.init();
    </script>
</body>
</html>
