<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Free Romantic Scratch Card Builder | Jega Digital</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8QZK8QQMC3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8QZK8QQMC3');
    </script>
    
    <!-- TikTok Pixel Code Start -->
    <script>
        !function (w, d, t) {
            w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};
            ttq.load('D5298KJC77U22M4JM01G');
            ttq.page();
        }(window, document, 'ttq');
    </script>
    <!-- TikTok Pixel Code End -->
    
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garabold:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --gold: #D4AF37;
            --gold-light: #F7E7CE;
            --pink: #FF1493;
            --pink-light: #FFB6C1;
            --text: #ffffff;
            --text-muted: #888888;
            --success: #4CAF50;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Floating Hearts Background */
        .hearts-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .floating-heart {
            position: absolute;
            opacity: 0.06;
            animation: float-heart linear infinite;
            font-size: 24px;
        }

        @keyframes float-heart {
            0% {
                transform: translateY(100vh) rotate(0deg) scale(1);
                opacity: 0;
            }
            10% {
                opacity: 0.06;
            }
            90% {
                opacity: 0.06;
            }
            100% {
                transform: translateY(-100px) rotate(360deg) scale(1.2);
                opacity: 0;
            }
        }

        .floating-heart:nth-child(odd) {
            animation-name: float-heart-sway;
        }

        @keyframes float-heart-sway {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.06;
            }
            50% {
                transform: translateY(50vh) translateX(30px) rotate(180deg);
            }
            90% {
                opacity: 0.06;
            }
            100% {
                transform: translateY(-100px) translateX(-30px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Social Proof Banner */
        .social-proof-banner {
            background: linear-gradient(90deg, var(--pink), var(--gold));
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            animation: pulse-banner 2s ease-in-out infinite;
        }

        @keyframes pulse-banner {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .social-proof-banner span {
            animation: fade-slide 4s ease-in-out infinite;
        }

        @keyframes fade-slide {
            0%, 100% { opacity: 1; }
            45%, 55% { opacity: 0; }
        }

        /* Live Activity Toast */
        .live-activity {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--bg-card);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            z-index: 999;
            transform: translateX(-120%);
            transition: transform 0.5s ease;
            max-width: 280px;
        }

        .live-activity.show {
            transform: translateX(0);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            top: 36px;
            left: 0;
            right: 0;
            padding: 12px 20px;
            background: var(--bg-dark);
            z-index: 999;
            border-bottom: 1px solid #222;
        }

        .progress-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 400px;
            margin: 0 auto;
        }

        .progress-step {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: var(--gold);
            color: #000;
        }

        .progress-step.completed {
            background: var(--success);
            color: #fff;
        }

        .progress-line {
            flex: 1;
            height: 2px;
            background: #333;
            margin: 0 8px;
            transition: background 0.3s ease;
        }

        .progress-line.active {
            background: var(--gold);
        }

        /* Main Container */
        .container {
            padding: 100px 20px 40px;
            max-width: 440px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* Step Screens */
        .step-screen {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .step-screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .step-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--gold), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .step-header p {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Theme Cards */
        .theme-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 30px;
        }

        .theme-card {
            background: var(--bg-card);
            border: 2px solid #333;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-card:hover {
            border-color: #555;
            transform: translateY(-2px);
        }

        .theme-card.selected {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 20, 147, 0.05));
        }

        .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .theme-preview.gold {
            background: linear-gradient(135deg, #D4AF37, #B8860B);
        }

        .theme-preview.pink {
            background: linear-gradient(135deg, #FF1493, #FF69B4);
        }

        .theme-preview.dark {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #333;
        }

        .theme-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .theme-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .theme-check {
            margin-left: auto;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-card.selected .theme-check {
            background: var(--gold);
            border-color: var(--gold);
            color: #000;
        }

        /* Input Fields */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            background: var(--bg-card);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 16px;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--gold);
        }

        .input-group textarea {
            resize: none;
            min-height: 100px;
        }

        .input-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Prize Suggestions */
        .prize-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .prize-chip {
            background: #222;
            border: 1px solid #333;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prize-chip:hover {
            background: #333;
            border-color: var(--gold);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 18px 24px;
            border: none;
            border-radius: 14px;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold), var(--pink));
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #333;
            color: var(--text);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            border-color: #555;
        }

        /* Email Capture Card */
        .email-capture {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(255, 20, 147, 0.1));
            border: 1px solid var(--gold);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        .email-capture h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .email-capture p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .email-benefits {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
            text-align: left;
        }

        .email-benefit {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .email-benefit span {
            color: var(--success);
        }

        /* Preview Card */
        .preview-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        .preview-phone {
            background: #000;
            border-radius: 24px;
            padding: 12px;
            margin-bottom: 20px;
            border: 3px solid #333;
        }

        .preview-screen {
            background: linear-gradient(135deg, #1a0a0a, #2d0a0a);
            border-radius: 16px;
            padding: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .preview-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 16px;
        }

        .preview-boxes {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .preview-box {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .preview-box.gold-theme {
            background: linear-gradient(135deg, #8B0000, #DC143C);
            border: 2px solid var(--gold);
        }

        .preview-box.pink-theme {
            background: linear-gradient(135deg, #FF1493, #FF69B4);
            border: 2px solid var(--pink-light);
        }

        .preview-box.dark-theme {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #4a4a6a;
        }

        .preview-from {
            font-size: 12px;
            color: var(--pink-light);
        }

        .btn-play {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: #fff;
            margin-top: 16px;
            animation: pulse-play 2s ease-in-out infinite;
        }

        .btn-play:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        @keyframes pulse-play {
            0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
        }

        /* Live Preview Modal */
        .live-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .live-preview-overlay.active {
            display: flex;
        }

        .live-preview-container {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .live-preview-close {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
        }

        .live-preview-header {
            text-align: center;
            padding: 20px;
        }

        .live-preview-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .live-preview-header p {
            color: var(--text-muted);
            font-size: 13px;
        }

        .scratch-game-container {
            padding: 20px;
        }

        .scratch-boxes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .scratch-box {
            aspect-ratio: 1;
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
        }

        .scratch-box-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
            border-radius: 12px;
        }

        .scratch-box-content.golden {
            background: linear-gradient(135deg, #D4AF37, #F7E7CE, #D4AF37);
            border: 2px solid #D4AF37;
        }

        .scratch-box-content.empty {
            background: linear-gradient(135deg, #4A0E0E, #6B1A1A);
            border: 2px solid #6B1A1A;
        }

        .scratch-box-content .icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .scratch-box-content .text {
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            line-height: 1.3;
        }

        .scratch-box-content.golden .text {
            color: #1a0a0a;
        }

        .scratch-box canvas {
            position: absolute;
            top: -5px;
            left: -5px;
            width: calc(100% + 10px);
            height: calc(100% + 10px);
            border-radius: 12px;
            z-index: 2;
        }

        .scratch-box.revealed canvas {
            display: none;
        }

        .scratch-box.revealed .scratch-box-content {
            animation: reveal-float 0.6s ease-out;
        }

        @keyframes reveal-float {
            0% {
                transform: scale(0.8) translateY(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) translateY(-15px);
                opacity: 1;
            }
            75% {
                transform: scale(1.05) translateY(-8px);
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .scratch-instruction {
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 20px;
        }

        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10002;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .play-again-btn {
            background: linear-gradient(135deg, var(--gold), var(--pink));
            color: #000;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
        }

        /* Paywall */
        .paywall-card {
            background: linear-gradient(135deg, var(--bg-card), #1a1a1a);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 30px 24px;
            text-align: center;
            margin-bottom: 24px;
        }

        .paywall-icon {
            font-size: 50px;
            margin-bottom: 16px;
        }

        .paywall-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 26px;
            margin-bottom: 8px;
            color: var(--gold);
        }

        .paywall-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .paywall-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .price-old {
            font-size: 18px;
            color: #666;
            text-decoration: line-through;
        }

        .price-new {
            font-size: 42px;
            font-weight: 700;
            color: var(--gold);
        }

        .price-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .paywall-features {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 24px;
            text-align: left;
        }

        .paywall-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .paywall-feature span {
            color: var(--success);
        }

        .secure-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 16px;
        }

        /* Success Screen */
        .success-animation {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .link-box {
            background: var(--bg-card);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .link-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 13px;
            outline: none;
        }

        .copy-btn {
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .share-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .share-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .share-btn.sms {
            background: var(--success);
            color: #fff;
        }

        .share-btn.copy {
            background: #333;
            color: #fff;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 11px;
            color: #444;
        }

        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 95px 16px 30px;
            }

            .step-header h1 {
                font-size: 24px;
            }

            .btn {
                padding: 16px 20px;
                font-size: 15px;
            }

            .live-activity {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Hearts Background -->
    <div class="hearts-background" id="heartsBackground"></div>

    <!-- Social Proof Banner -->
    <div class="social-proof-banner">
        <span id="proofText">üî• 127 couples created cards in the last hour</span>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-step active" id="prog1">1</div>
            <div class="progress-line" id="line1"></div>
            <div class="progress-step" id="prog2">2</div>
            <div class="progress-line" id="line2"></div>
            <div class="progress-step" id="prog3">3</div>
            <div class="progress-line" id="line3"></div>
            <div class="progress-step" id="prog4">4</div>
        </div>
    </div>

    <!-- Live Activity Toast -->
    <div class="live-activity" id="liveActivity">
        <div class="live-dot"></div>
        <div>
            <strong id="activityName">Sarah from Texas</strong>
            <div style="font-size: 11px; color: var(--text-muted);" id="activityAction">just created a card</div>
        </div>
    </div>

    <div class="container">
        
        <!-- STEP 1: Choose Theme -->
        <div class="step-screen active" id="step1">
            <div class="step-header">
                <h1>‚ú® Create Your Card</h1>
                <p>Choose a theme that matches the vibe</p>
            </div>

            <div class="theme-grid">
                <div class="theme-card selected" data-theme="gold" onclick="selectTheme(this, 'gold')">
                    <div class="theme-preview gold">üî•</div>
                    <div class="theme-info">
                        <h3>Romantic Gold</h3>
                        <p>Classic, luxurious & timeless</p>
                    </div>
                    <div class="theme-check">‚úì</div>
                </div>

                <div class="theme-card" data-theme="pink" onclick="selectTheme(this, 'pink')">
                    <div class="theme-preview pink">üíï</div>
                    <div class="theme-info">
                        <h3>Hot Pink</h3>
                        <p>Playful, fun & flirty</p>
                    </div>
                    <div class="theme-check">‚úì</div>
                </div>

                <div class="theme-card" data-theme="dark" onclick="selectTheme(this, 'dark')">
                    <div class="theme-preview dark">üåô</div>
                    <div class="theme-info">
                        <h3>Midnight Dark</h3>
                        <p>Mysterious & seductive</p>
                    </div>
                    <div class="theme-check">‚úì</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="nextStep(2)">
                Continue <span>‚Üí</span>
            </button>
        </div>

        <!-- STEP 2: Customize -->
        <div class="step-screen" id="step2">
            <div class="step-header">
                <h1>üíù Personalize It</h1>
                <p>Make it special for your person</p>
            </div>

            <div class="input-group">
                <label>Their Name (who receives this)</label>
                <input type="text" id="recipientName" placeholder="e.g. Babe, My Love, Daddy..." maxlength="20">
            </div>

            <div class="input-group">
                <label>Your Name (the sender)</label>
                <input type="text" id="senderName" placeholder="e.g. Your Girl, Wifey, Baby..." maxlength="20">
            </div>

            <div class="input-group">
                <label>The Golden Prize üéüÔ∏è (what they win)</label>
                <textarea id="prizeText" placeholder="e.g. 30 Minute Full Body Massage..."></textarea>
                <p class="input-hint">Be creative üòè This is what they'll reveal!</p>
                
                <div class="prize-suggestions">
                    <div class="prize-chip" onclick="setPrize('30 Min Massage üíÜ')">30 Min Massage üíÜ</div>
                    <div class="prize-chip" onclick="setPrize('Breakfast in Bed ü•û')">Breakfast in Bed ü•û</div>
                    <div class="prize-chip" onclick="setPrize('Movie Night Your Pick üé¨')">Movie Night üé¨</div>
                    <div class="prize-chip" onclick="setPrize('Whatever You Want Tonight üòè')">Whatever You Want üòè</div>
                    <div class="prize-chip" onclick="setPrize('Full Body Worship üî•')">Full Body Worship üî•</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="nextStep(3)" id="step2Btn">
                Continue <span>‚Üí</span>
            </button>
            <button class="btn btn-secondary" onclick="prevStep(1)">
                ‚Üê Back
            </button>
        </div>

        <!-- STEP 3: Email Capture + Preview -->
        <div class="step-screen" id="step3">
            <div class="step-header">
                <h1>üëÄ Preview Your Card</h1>
                <p>Here's what they'll see</p>
            </div>

            <div class="preview-card">
                <div class="preview-phone">
                    <div class="preview-screen" id="previewScreen">
                        <div class="preview-title" id="previewTitle">üíï Surprise for Babe üíï</div>
                        <div class="preview-boxes" id="previewBoxes">
                            <div class="preview-box gold-theme">üíï</div>
                            <div class="preview-box gold-theme">üíï</div>
                            <div class="preview-box gold-theme">üíï</div>
                        </div>
                        <div class="preview-from" id="previewFrom">From: Your Girl</div>
                    </div>
                </div>
                <p style="font-size: 12px; color: var(--text-muted);">They'll scratch to reveal: "<span id="previewPrize">30 Min Massage</span>"</p>
                
                <!-- Play Preview Button -->
                <button class="btn btn-play" onclick="openLivePreview()">
                    ‚ñ∂Ô∏è Play & Experience Your Card
                </button>
            </div>

            <!-- Email Capture -->
            <div class="email-capture">
                <h3>üéÅ Almost Done!</h3>
                <p>Enter your email to save your card & get exclusive couple tips</p>
                
                <div class="email-benefits">
                    <div class="email-benefit"><span>‚úì</span> Save your card forever</div>
                    <div class="email-benefit"><span>‚úì</span> Get notified when they open it</div>
                    <div class="email-benefit"><span>‚úì</span> Unlimited edits & links with this email</div>
                </div>
                
                <div class="input-group" style="margin-bottom: 0;">
                    <input type="email" id="userEmail" placeholder="your@email.com" required>
                    <p class="email-error" id="emailError" style="color: #ff6b6b; font-size: 12px; margin-top: 8px; display: none;">‚ö†Ô∏è Please enter a valid email address</p>
                </div>
            </div>

            <button class="btn btn-primary" onclick="validateAndProceed()" id="step3Btn">
                Generate My Link üîó
            </button>
            <button class="btn btn-secondary" onclick="prevStep(2)">
                ‚Üê Back
            </button>
        </div>

        <!-- STEP 4: Paywall -->
        <div class="step-screen" id="step4">
            <div class="step-header">
                <h1>üöÄ Ready to Send!</h1>
                <p>One small step to surprise them</p>
            </div>

            <div class="paywall-card">
                <div class="paywall-icon">üîê</div>
                <div class="paywall-title">Unlock Your Link</div>
                <div class="paywall-subtitle">One-time fee ‚Ä¢ Unlimited access forever</div>
                
                <div class="paywall-price">
                    <span class="price-old">$5.99</span>
                    <div>
                        <div class="price-new">$1.99</div>
                        <div class="price-label">Launch Special üî•</div>
                    </div>
                </div>

                <div class="paywall-features">
                    <div class="paywall-feature"><span>‚úì</span> Unlimited links forever</div>
                    <div class="paywall-feature"><span>‚úì</span> Edit & create new cards anytime</div>
                    <div class="paywall-feature"><span>‚úì</span> Works on any phone</div>
                    <div class="paywall-feature"><span>‚úì</span> Links never expire</div>
                </div>

                <button class="btn btn-primary" id="paymentBtn" onclick="processPayment()">
                    üí≥ Pay $1.99 & Get Link
                </button>
                
                <p id="paymentError" style="color: #ff6b6b; font-size: 12px; margin-top: 12px; display: none;"></p>

                <div class="secure-badge">
                    üîí Secure payment via Stripe
                </div>
            </div>

            <button class="btn btn-secondary" onclick="prevStep(3)">
                ‚Üê Back to Preview
            </button>
        </div>

        <!-- STEP 5: Success -->
        <div class="step-screen" id="step5">
            <div class="step-header">
                <div class="success-animation">üéâ</div>
                <h1>You're All Set!</h1>
                <p>Send this link to your lover</p>
            </div>

            <div class="link-box">
                <input type="text" id="generatedLink" value="https://jega.digital/s/abc123" readonly>
                <button class="copy-btn" onclick="copyLink()">Copy</button>
            </div>

            <div class="share-buttons">
                <button class="share-btn sms" onclick="shareViaSMS()">
                    üí¨ Send via Text
                </button>
                <button class="share-btn copy" onclick="copyLink()">
                    üìã Copy Link
                </button>
            </div>
            
            <!-- Preview Button -->
            <button class="btn btn-preview" onclick="previewCreatedCard()" style="margin-top: 16px; background: linear-gradient(135deg, #ffc300, #2E7D32); color: #fff;">
                üëÄ Preview What They'll See
            </button>

            <div style="margin-top: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; text-align: center;">
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">üí° Pro tip: Send it with no context for maximum surprise!</p>
                <p style="font-size: 12px; color: #666;">Example text: "Open this when you have a minute üòè"</p>
            </div>
        </div>

        <div class="footer">
            üíï Made with love by Jega Digital
            <br><br>
            <button onclick="createNewCard()" style="background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                ‚ú® Create Another Card
            </button>
        </div>
    </div>

    <!-- Live Preview Modal -->
    <div class="live-preview-overlay" id="livePreviewOverlay">
        <button class="live-preview-close" onclick="closeLivePreview()">‚úï</button>
        
        <div class="live-preview-container">
            <div class="live-preview-header">
                <h2 id="livePreviewTitle">üíï Surprise for Babe üíï</h2>
                <p id="livePreviewFrom">From: Your Girl</p>
            </div>
            
            <p class="scratch-instruction">‚ú® Scratch each box to reveal what's inside ‚ú®</p>
            
            <div class="scratch-game-container">
                <div class="scratch-boxes-grid" id="scratchBoxesGrid">
                    <!-- Boxes generated by JS -->
                </div>
                
                <button class="play-again-btn" onclick="resetLivePreview()">
                    ‚Üª Play Again
                </button>
                
                <button class="btn btn-secondary" onclick="closeLivePreview();">
                    ‚Üê Back to Editor
                </button>
            </div>
        </div>
    </div>
    
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        // ============================================
        // LIVE PREVIEW SCRATCH GAME
        // ============================================
        
        let winningBoxIndex = 0;
        
        function openLivePreview() {
            // Update preview with card data
            document.getElementById('livePreviewTitle').textContent = `üíï Surprise for ${cardData.recipientName || 'Babe'} üíï`;
            document.getElementById('livePreviewFrom').textContent = `From: ${cardData.senderName || 'Your Secret Admirer'}`;
            
            // Show overlay
            document.getElementById('livePreviewOverlay').classList.add('active');
            
            // Generate scratch boxes
            generateScratchBoxes();
            
            // Track event
            gtag('event', 'preview_played', { theme: cardData.theme });
        }
        
        function closeLivePreview() {
            document.getElementById('livePreviewOverlay').classList.remove('active');
        }
        
        function generateScratchBoxes() {
            const grid = document.getElementById('scratchBoxesGrid');
            grid.innerHTML = '';
            
            // Randomly select winning box
            winningBoxIndex = Math.floor(Math.random() * 3);
            
            const emptyMessages = [
                { icon: 'üòè', text: 'Not this one...<br>Keep scratching!' },
                { icon: 'üíã', text: 'Try again,<br>love...' }
            ];
            
            let emptyIndex = 0;
            
            for (let i = 0; i < 3; i++) {
                const box = document.createElement('div');
                box.className = 'scratch-box';
                box.id = `scratch-box-${i}`;
                
                const content = document.createElement('div');
                content.className = 'scratch-box-content';
                
                if (i === winningBoxIndex) {
                    content.classList.add('golden');
                    content.innerHTML = `
                        <div class="icon">üéüÔ∏è</div>
                        <div class="text">${cardData.prize || '30 Min Massage'}</div>
                    `;
                } else {
                    content.classList.add('empty');
                    const msg = emptyMessages[emptyIndex];
                    content.innerHTML = `
                        <div class="icon">${msg.icon}</div>
                        <div class="text">${msg.text}</div>
                    `;
                    emptyIndex = (emptyIndex + 1) % emptyMessages.length;
                }
                
                // Create canvas for scratch effect
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                
                box.appendChild(content);
                box.appendChild(canvas);
                grid.appendChild(box);
                
                // Initialize scratch functionality
                initScratchCanvas(canvas, box, i);
            }
        }
        
        function initScratchCanvas(canvas, box, boxIndex) {
            const ctx = canvas.getContext('2d');
            let isScratching = false;
            let lastX = 0;
            let lastY = 0;
            
            // Draw scratch cover based on theme
            drawScratchCover(ctx, canvas.width, canvas.height);
            
            function drawScratchCover(ctx, width, height) {
                // First fill entire canvas with solid dark color to prevent bleed-through
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, width, height);
                
                let gradient;
                let ribbonColor;
                let bowColor;
                
                if (cardData.theme === 'pink') {
                    gradient = ctx.createLinearGradient(0, 0, width, height);
                    gradient.addColorStop(0, '#FF1493');
                    gradient.addColorStop(0.5, '#FF69B4');
                    gradient.addColorStop(1, '#FF1493');
                    ribbonColor = '#FFB6C1';
                    bowColor = '#FF69B4';
                } else if (cardData.theme === 'dark') {
                    gradient = ctx.createLinearGradient(0, 0, width, height);
                    gradient.addColorStop(0, '#1a1a2e');
                    gradient.addColorStop(0.5, '#16213e');
                    gradient.addColorStop(1, '#0f0f1a');
                    ribbonColor = '#4a4a6a';
                    bowColor = '#6a6a8a';
                } else {
                    gradient = ctx.createLinearGradient(0, 0, width, height);
                    gradient.addColorStop(0, '#8B0000');
                    gradient.addColorStop(0.5, '#DC143C');
                    gradient.addColorStop(1, '#8B0000');
                    ribbonColor = '#FFB6C1';
                    bowColor = '#FF69B4';
                }
                
                // Fill main background
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
                
                // Add extra solid layer to ensure no bleed-through
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
                
                // Draw ribbon
                ctx.strokeStyle = ribbonColor;
                ctx.lineWidth = 12;
                ctx.beginPath();
                ctx.moveTo(width / 2, 0);
                ctx.lineTo(width / 2, height);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, height / 2);
                ctx.lineTo(width, height / 2);
                ctx.stroke();
                
                // Draw bow circle
                ctx.fillStyle = bowColor;
                ctx.beginPath();
                ctx.arc(width / 2, height / 2, 25, 0, Math.PI * 2);
                ctx.fill();
                
                // Heart emoji
                ctx.fillStyle = '#fff';
                ctx.font = '32px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üíï', width / 2, height / 2);
                
                // "SCRATCH ME" text
                ctx.fillStyle = cardData.theme === 'dark' ? '#8a8aaa' : '#FFE4E1';
                ctx.font = 'bold 14px Arial';
                ctx.fillText('SCRATCH ME', width / 2, height - 20);
            }
            
            function scratch(x, y) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 40;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                ctx.fill();
                
                lastX = x;
                lastY = y;
            }
            
            function calculateScratched() {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let transparent = 0;
                
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] === 0) transparent++;
                }
                
                const percentage = (transparent / (pixels.length / 4)) * 100;
                
                if (percentage > 60) {
                    revealBox(box, boxIndex);
                }
            }
            
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', (e) => {
                isScratching = true;
                const { x, y } = getCoordinates(e);
                lastX = x;
                lastY = y;
                scratch(x, y);
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isScratching) return;
                const { x, y } = getCoordinates(e);
                scratch(x, y);
            });
            
            canvas.addEventListener('mouseup', () => {
                isScratching = false;
                calculateScratched();
            });
            
            canvas.addEventListener('mouseleave', () => {
                if (isScratching) {
                    isScratching = false;
                    calculateScratched();
                }
            });
            
            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isScratching = true;
                const { x, y } = getCoordinates(e);
                lastX = x;
                lastY = y;
                scratch(x, y);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isScratching) return;
                const { x, y } = getCoordinates(e);
                scratch(x, y);
            });
            
            canvas.addEventListener('touchend', () => {
                isScratching = false;
                calculateScratched();
            });
        }
        
        function revealBox(box, boxIndex) {
            if (box.classList.contains('revealed')) return;
            
            box.classList.add('revealed');
            
            if (boxIndex === winningBoxIndex) {
                // Winner! Celebrate!
                createConfetti();
                gtag('event', 'preview_won');
            }
        }
        
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#D4AF37', '#FF1493', '#FFB6C1', '#F7E7CE', '#4CAF50'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }
        
        function resetLivePreview() {
            generateScratchBoxes();
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        let currentStep = 1;
        let cardData = {
            theme: 'gold',
            recipientName: '',
            senderName: '',
            prize: '',
            email: ''
        };

        // ============================================
        // SOCIAL PROOF
        // ============================================
        
        const proofMessages = [
            "üî• 127 couples created cards in the last hour",
            "üíï Sarah just sent a card to her boyfriend",
            "üéâ 2,847 surprises delivered this week",
            "üòè Ashley from Miami just created a spicy card",
            "üíù Join 10,000+ couples using Jega Digital"
        ];

        const activityNames = [
            "Sarah from Texas", "Emily from LA", "Jessica from Miami",
            "Ashley from NYC", "Brittany from Chicago", "Megan from Atlanta",
            "Amanda from Seattle", "Stephanie from Denver", "Lauren from Boston"
        ];

        const activityActions = [
            "just created a card",
            "just sent a surprise",
            "just unlocked their link",
            "is customizing a card"
        ];

        let proofIndex = 0;
        setInterval(() => {
            proofIndex = (proofIndex + 1) % proofMessages.length;
            document.getElementById('proofText').textContent = proofMessages[proofIndex];
        }, 5000);

        // Show live activity toast randomly
        function showLiveActivity() {
            const name = activityNames[Math.floor(Math.random() * activityNames.length)];
            const action = activityActions[Math.floor(Math.random() * activityActions.length)];
            
            document.getElementById('activityName').textContent = name;
            document.getElementById('activityAction').textContent = action;
            
            const toast = document.getElementById('liveActivity');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Show first toast after 3 seconds, then every 15-30 seconds
        setTimeout(showLiveActivity, 3000);
        setInterval(() => {
            if (Math.random() > 0.3) showLiveActivity();
        }, 20000);

        // ============================================
        // THEME SELECTION
        // ============================================
        
        function selectTheme(element, theme) {
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            cardData.theme = theme;
            
            // Track event
            gtag('event', 'theme_selected', { theme: theme });
        }

        // ============================================
        // PRIZE SUGGESTIONS
        // ============================================
        
        function setPrize(text) {
            document.getElementById('prizeText').value = text;
            cardData.prize = text;
        }

        // ============================================
        // NAVIGATION
        // ============================================
        
        function nextStep(step) {
            // Validate current step
            if (currentStep === 2) {
                cardData.recipientName = document.getElementById('recipientName').value || 'Babe';
                cardData.senderName = document.getElementById('senderName').value || 'Your Secret Admirer';
                cardData.prize = document.getElementById('prizeText').value || '30 Min Massage';
                
                if (!cardData.prize) {
                    alert('Please enter a prize!');
                    return;
                }
                
                updatePreview();
            }
            
            if (currentStep === 3) {
                cardData.email = document.getElementById('userEmail').value;
                
                if (cardData.email) {
                    // Track email capture
                    gtag('event', 'email_captured', { email: cardData.email });
                    
                    // Store email (in real app, send to server)
                    localStorage.setItem('jega_user_email', cardData.email);
                }
            }

            // Update progress bar
            document.getElementById(`prog${currentStep}`).classList.remove('active');
            document.getElementById(`prog${currentStep}`).classList.add('completed');
            if (currentStep < 4) {
                document.getElementById(`line${currentStep}`).classList.add('active');
            }
            document.getElementById(`prog${step}`).classList.add('active');
            
            // Show new step
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
            
            // Track step
            gtag('event', 'step_completed', { step: step });
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep(step) {
            document.getElementById(`prog${currentStep}`).classList.remove('active');
            document.getElementById(`prog${step}`).classList.remove('completed');
            document.getElementById(`prog${step}`).classList.add('active');
            if (step < currentStep) {
                document.getElementById(`line${step}`).classList.remove('active');
            }
            
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // PREVIEW UPDATE
        // ============================================
        
        function updatePreview() {
            document.getElementById('previewTitle').textContent = `üíï Surprise for ${cardData.recipientName} üíï`;
            document.getElementById('previewFrom').textContent = `From: ${cardData.senderName}`;
            document.getElementById('previewPrize').textContent = cardData.prize;
            
            // Update theme
            const boxes = document.querySelectorAll('.preview-box');
            boxes.forEach(box => {
                box.className = 'preview-box ' + cardData.theme + '-theme';
            });
        }

        // ============================================
        // SUPABASE SETUP
        // ============================================
        
        const SUPABASE_URL = 'https://twksmudlxypozatfulzc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3a3NtdWRseHlwb3phdGZ1bHpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwOTQ0NjAsImV4cCI6MjA4MTY3MDQ2MH0.wmq7QyIIT0fzbt0Tn7FXnzhOaOsJOqyj0eNW-G5wHHI';
        
        let supabaseClient = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (e) {
            console.log('Supabase init error:', e);
        }
        
        // Check if email has paid (from Supabase)
        async function checkIfPaid(email) {
            if (!supabaseClient) return false;
            try {
                const { data, error } = await supabaseClient
                    .from('paid_emails')
                    .select('email')
                    .eq('email', email.toLowerCase())
                    .single();
                
                if (data) return true;
                return false;
            } catch (error) {
                console.log('Supabase check:', error);
                return false;
            }
        }
        
        // Save paid email to Supabase
        async function savePaidEmail(email, cardData) {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('paid_emails')
                    .insert([
                        { 
                            email: email.toLowerCase(),
                            card_data: cardData
                        }
                    ]);
                
                if (error) {
                    console.log('Already exists or error:', error);
                } else {
                    console.log('‚úÖ Email saved to Supabase:', email);
                }
            } catch (error) {
                console.log('Supabase save error:', error);
            }
        }

        // ============================================
        // EMAIL VALIDATION & STEP 3 PROCEED
        // ============================================
        
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }
        
        async function validateAndProceed() {
            const emailInput = document.getElementById('userEmail');
            const emailError = document.getElementById('emailError');
            const email = emailInput.value.trim();
            
            if (!email || !validateEmail(email)) {
                emailError.style.display = 'block';
                emailInput.style.borderColor = '#ff6b6b';
                emailInput.focus();
                return;
            }
            
            emailError.style.display = 'none';
            emailInput.style.borderColor = 'var(--gold)';
            cardData.email = email;
            
            // Save email to localStorage
            localStorage.setItem('jega_user_email', email);
            
            // Track email capture - TikTok & GA
            ttq.track('AddToCart', {
                content_type: 'product',
                content_id: 'scratch_card',
                content_name: 'Jega Digital Scratch Card',
                value: 1.99,
                currency: 'USD'
            });
            gtag('event', 'add_to_cart', { value: 1.99, currency: 'USD' });
            
            // Check if user has already paid - SUPABASE FIRST
            const isPaidInSupabase = await checkIfPaid(email);
            if (isPaidInSupabase) {
                // User already paid - skip paywall!
                console.log('‚úÖ Paid user found in Supabase:', email);
                generateLinkForPaidUser();
                return;
            }
            
            // Fallback: Check localStorage and manual list
            const paidEmails = JSON.parse(localStorage.getItem('jega_paid_emails') || '[]');
            
            // Manual list of paid emails (backup)
            const manualPaidEmails = [
                'garcia.jerry22@live.com',
            ];
            
            const allPaidEmails = [...paidEmails, ...manualPaidEmails];
            
            if (allPaidEmails.includes(email.toLowerCase())) {
                // User already paid - skip paywall!
                generateLinkForPaidUser();
                return;
            }
            
            // Send email to Google Sheets (lead capture)
            sendToGoogleSheets(email, 'lead', cardData);
            
            // Proceed to paywall
            nextStep(4);
        }
        
        // ============================================
        // GOOGLE SHEETS INTEGRATION
        // ============================================
        
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzz7K2XPY04cYmJm_oo7hVQCKRleL5ji-XqnHsTV-gWKHxSyYIA204JyP6Q84QqfRt_/exec';
        
        function sendToGoogleSheets(email, type, data) {
            // Send data to Google Sheets
            const payload = {
                email: email,
                type: type, // 'lead' or 'paid'
                date: new Date().toISOString(),
                cardData: JSON.stringify(data)
            };
            
            // Use navigator.sendBeacon for reliability
            const formData = new FormData();
            Object.keys(payload).forEach(key => formData.append(key, payload[key]));
            
            fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            }).catch(err => console.log('Sheet save attempted'));
            
            console.log('üìß Email captured:', email, type);
        }

        // ============================================
        // STRIPE PAYMENT
        // ============================================
        
        const stripe = Stripe('pk_live_51Sfl7mLoHk00vlXFcR5GNjAWsSHmR9PQ77UBv3XfZWl0A1nCrkzG6GwijJOvQp4yodELHXj3BfWM6LbQuodTICEh00rMVYHgdq');
        
        async function processPayment() {
            const btn = document.getElementById('paymentBtn');
            const errorEl = document.getElementById('paymentError');
            
            btn.innerHTML = '‚è≥ Processing...';
            btn.disabled = true;
            errorEl.style.display = 'none';
            
            // Track payment attempt
            gtag('event', 'payment_initiated', { 
                value: 1.99,
                currency: 'USD',
                email: cardData.email
            });
            
            // TikTok - Initiate Checkout
            ttq.track('InitiateCheckout', {
                content_type: 'product',
                content_id: 'scratch_card',
                content_name: 'Jega Digital Scratch Card',
                value: 1.99,
                currency: 'USD'
            });

            try {
                // Create Stripe Checkout Session via client-side redirect
                // Note: For production, you should create sessions server-side
                // This uses Stripe Payment Links as a simpler alternative
                
                const paymentSuccess = await openStripeCheckout();
                
                if (paymentSuccess) {
                    completePayment();
                }
            } catch (error) {
                console.error('Payment error:', error);
                errorEl.textContent = 'Payment failed. Please try again.';
                errorEl.style.display = 'block';
                btn.innerHTML = 'üí≥ Pay $1.99 & Get Link';
                btn.disabled = false;
            }
        }
        
        function openStripeCheckout() {
            return new Promise((resolve, reject) => {
                // Store card data for after payment
                localStorage.setItem('jega_pending_card', JSON.stringify(cardData));
                
                // Redirect to Stripe Payment Link
                window.location.href = 'https://buy.stripe.com/3cI6oIab33DM6fv0Lx5gc01?client_reference_id=' + encodeURIComponent(cardData.email);
            });
        }
        
        function completePayment() {
            // Save to Supabase (permanent storage)
            savePaidEmail(cardData.email, cardData);
            
            // Also mark email as paid in localStorage (backup)
            const paidEmails = JSON.parse(localStorage.getItem('jega_paid_emails') || '[]');
            if (!paidEmails.includes(cardData.email.toLowerCase())) {
                paidEmails.push(cardData.email.toLowerCase());
                localStorage.setItem('jega_paid_emails', JSON.stringify(paidEmails));
            }
            
            // Send to Google Sheets as paid customer
            sendToGoogleSheets(cardData.email, 'paid', cardData);
            
            // Track successful payment
            gtag('event', 'purchase', {
                value: 1.99,
                currency: 'USD',
                transaction_id: Date.now().toString(),
                email: cardData.email
            });
            
            // TikTok - Complete Payment
            ttq.track('CompletePayment', {
                content_type: 'product',
                content_id: 'scratch_card',
                content_name: 'Jega Digital Scratch Card',
                value: 1.99,
                currency: 'USD'
            });
            
            // Generate the link
            generateLink();
        }
        
        function generateLinkForPaidUser() {
            // User already paid - go straight to link generation
            gtag('event', 'returning_paid_user', { email: cardData.email });
            generateLink();
        }
        
        function generateLink() {
            // Generate the shareable link
            const params = new URLSearchParams({
                r: cardData.recipientName || 'Babe',
                s: cardData.senderName || 'Your Secret Admirer',
                p: cardData.prize || '30 Min Massage',
                t: cardData.theme || 'gold'
            });
            
            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            const generatedLink = baseUrl + 'play.html?' + params.toString();
            
            document.getElementById('generatedLink').value = generatedLink;
            
            // Store card data
            localStorage.setItem('jega_last_card', JSON.stringify(cardData));
            
            // Update progress bar
            document.getElementById('prog3').classList.remove('active');
            document.getElementById('prog3').classList.add('completed');
            document.getElementById('line3').classList.add('active');
            document.getElementById('prog4').classList.add('active');
            document.getElementById('prog4').classList.remove('active');
            document.getElementById('prog4').classList.add('completed');
            
            // Show success step
            document.querySelectorAll('.step-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('step5').classList.add('active');
            
            currentStep = 5;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // SHARE FUNCTIONS
        // ============================================
        
        function copyLink() {
            const link = document.getElementById('generatedLink').value;
            navigator.clipboard.writeText(link).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = 'Copied! ‚úì';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                gtag('event', 'link_copied');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.getElementById('generatedLink');
                input.select();
                document.execCommand('copy');
                alert('Link copied!');
            });
        }
        
        function previewCreatedCard() {
            const link = document.getElementById('generatedLink').value;
            window.open(link, '_blank');
            gtag('event', 'preview_clicked');
        }
        
        function createNewCard() {
            // Reset card data
            cardData = {
                theme: 'gold',
                recipientName: '',
                senderName: '',
                prize: '',
                email: localStorage.getItem('jega_user_email') || ''
            };
            
            // Reset form fields
            document.getElementById('recipientName').value = '';
            document.getElementById('senderName').value = '';
            document.getElementById('prizeText').value = '';
            
            // Reset progress bar
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index === 0) step.classList.add('active');
            });
            document.querySelectorAll('.progress-line').forEach(line => {
                line.classList.remove('active');
            });
            
            // Reset theme selection
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.theme === 'gold') card.classList.add('selected');
            });
            
            // Go back to step 1
            document.querySelectorAll('.step-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            currentStep = 1;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            gtag('event', 'create_new_card');
        }

        function shareViaSMS() {
            const link = document.getElementById('generatedLink').value;
            const message = encodeURIComponent(`Open this when you have a minute üòè ${link}`);
            
            // Detect if iOS or Android
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOS) {
                window.location.href = `sms:&body=${message}`;
            } else {
                window.location.href = `sms:?body=${message}`;
            }
            
            gtag('event', 'share_sms');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Track page view
        gtag('event', 'generator_loaded');
        
        // Load saved email if exists
        const savedEmail = localStorage.getItem('jega_user_email');
        if (savedEmail) {
            document.getElementById('userEmail').value = savedEmail;
        }
        
        // Create floating hearts background
        function createFloatingHearts() {
            const container = document.getElementById('heartsBackground');
            const hearts = ['üíï', '‚ô°', 'üíó', '‚ù§Ô∏è', 'üíñ', '‚ô•', 'üíù'];
            
            for (let i = 0; i < 20; i++) {
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.fontSize = (16 + Math.random() * 20) + 'px';
                heart.style.animationDuration = (15 + Math.random() * 20) + 's';
                heart.style.animationDelay = (Math.random() * 15) + 's';
                container.appendChild(heart);
            }
        }
        
        createFloatingHearts();
    </script>
</body>
</html>
