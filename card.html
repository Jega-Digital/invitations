<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A Special Invitation</title>
    
    <!-- Open Graph Data -->
    <meta property="og:image" content="https://images.unsplash.com/photo-1605218427306-635ba2439af2?q=80&w=600&auto=format&fit=crop">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- CUSTOM FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Combined your Tangerine font with Playfair Display (Required for main message) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Tangerine:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* General Styles */
        body { margin: 0; padding: 0; background-color: #fdf6f0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: 'Playfair Display', serif; overflow: hidden; color: #5a4a42; }
        .card-container { position: relative; width: 320px; height: 480px; background: #fff; border-radius: 20px; box-shadow: 0 25px 60px rgba(90, 74, 66, 0.2); overflow: hidden; }
        
        /* Prize Layer (Your Background) */
        #prize-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            padding: 30px; box-sizing: border-box;
            /* Floral Background + Overlay */
            background-image: linear-gradient(rgba(255, 253, 245, 0.85), rgba(255, 253, 245, 0.85)), url('https://images.unsplash.com/photo-1526047932273-341f2a7631f9?q=80&w=600&auto=format&fit=crop');
            background-size: cover; background-position: center;
            border: 8px double #d4af37; border-radius: 20px; z-index: 1;
        }

        /* PRIZE TITLE (Your custom Tangerine font/color) */
        .prize-title { 
            font-family: 'Tangerine', cursive; 
            font-size: 38px; 
            color: #000000; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 0px #fff; 
            line-height: 1.1; /* Ensure multi-line titles don't space out too much */
        }
        .prize-message { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #3d2e27; line-height: 1.2; padding: 0 10px; margin-bottom: 15px; }
        
        /* Prize Details (Your Custom Box) */
        .prize-details { border-top: 1px solid #c5a059; border-bottom: 1px solid #c5a059; padding: 10px 0; margin-top: 10px; width: 80%; background: rgba(255,255,255,0.7); }
        .detail-item { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: #8c7b70; margin-top: 5px; }
        .detail-value { font-size: 14px; font-weight: 600; color: #3d2e27; margin-bottom: 5px; }
        .brand-footer { position: absolute; bottom: 20px; font-size: 10px; color: #cba773; letter-spacing: 2px; text-transform: uppercase; }

        /* Scratch Layer */
        canvas { 
            position: absolute; top: 0; left: 0; z-index: 2; cursor: pointer; border-radius: 20px; touch-action: none; 
            transition: opacity 0.5s ease; /* Allows canvas to fade out */
        }
        .instructions { margin-top: 25px; color: #a39288; font-size: 13px; letter-spacing: 1px; text-transform: uppercase; animation: pulse 2s infinite; font-family: sans-serif; }
        
        /* === NEW ANIMATION CSS === */
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3; /* Above the scratch layer */
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #d4af37; /* Gold color */
            border-radius: 50%;
            opacity: 0;
            transform: translateY(0);
        }
        
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(480px) rotate(360deg); opacity: 0; }
        }

        .burst-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(252,217,143,0.5) 50%, rgba(255,255,255,0) 100%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: burst 1s forwards;
            z-index: 4;
        }
        
        @keyframes burst {
            0% { opacity: 1; transform: scale(0.5) translate(-50%, -50%); }
            50% { opacity: 0.8; transform: scale(1.5) translate(-50%, -50%); }
            100% { opacity: 0; transform: scale(2.0) translate(-50%, -50%); }
        }
        /* End of New CSS */

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="card-container">
        <!-- ADDED CONFETTI CONTAINER -->
        <div id="confetti-container"></div> 
        
        <div id="prize-layer">
            <div class="prize-title" id="card-title">A Special Invitation</div>
            <div class="prize-message" id="prize-text">Loading...</div>
            <div class="prize-details" id="details-container">
                <div id="date-group"><div class="detail-item">Date</div><div class="detail-value" id="card-date">--</div></div>
                <div id="time-group"><div class="detail-item">Time</div><div class="detail-value" id="card-time">--</div></div>
                <div id="location-group"><div class="detail-item">Location</div><div class="detail-value" id="card-location">--</div></div>
            </div>
            <div class="brand-footer">With Love</div>
        </div>
        <canvas id="scratchCanvas"></canvas>
    </div>
    <p class="instructions">Rub screen to reveal</p>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        
        // --- DATA FILLING ---
        document.getElementById('prize-text').innerText = urlParams.get('msg') || "Scratch to reveal!";
        const titleParam = urlParams.get('title'); if (titleParam) document.getElementById('card-title').innerText = titleParam;
        const dateParam = urlParams.get('date'); const timeParam = urlParams.get('time'); const locParam = urlParams.get('loc');
        if (dateParam) document.getElementById('card-date').innerText = dateParam; else document.getElementById('date-group').style.display = "none"; 
        if (timeParam) document.getElementById('card-time').innerText = timeParam; else document.getElementById('time-group').style.display = "none";
        if (locParam) document.getElementById('card-location').innerText = locParam; else document.getElementById('location-group').style.display = "none";
        if (!dateParam && !timeParam && !locParam) document.getElementById('details-container').style.display = 'none';

        // --- CANVAS SETUP ---
        const canvas = document.getElementById('scratchCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.querySelector('.card-container');
        
        // NEW GLOBAL VARS FOR ANIMATION
        const confettiContainer = document.getElementById('confetti-container');
        const totalPixels = canvas.width * canvas.height;
        let isComplete = false;

        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr); canvas.style.width = `${rect.width}px`; canvas.style.height = `${rect.height}px`;

        function drawFoil() {
            // Your custom drawFoil function logic
            const gradient = ctx.createLinearGradient(0, 0, rect.width, rect.height);
            gradient.addColorStop(0, '#C5A059'); gradient.addColorStop(0.3, '#E6C776'); gradient.addColorStop(0.6, '#C5A059'); gradient.addColorStop(1, '#E6C776'); 
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, rect.width, rect.height);
            for (let i = 0; i < 5000; i++) { ctx.fillStyle = `rgba(255,255,255, ${Math.random() * 0.3})`; ctx.beginPath(); ctx.arc(Math.random() * rect.width, Math.random() * rect.height, Math.random() * 2, 0, Math.PI * 2); ctx.fill(); }
            
            // NOTE: Using Playfair Display here for the scratch text, as Tangerine is too thin to read.
            ctx.fillStyle = "rgba(255,255,255,0.9)"; 
            ctx.font = "italic 600 24px 'Playfair Display'"; 
            ctx.textAlign = "center"; ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 5; 
            ctx.fillText("Scratch to Reveal", rect.width/2, rect.height/2);
        }
        drawFoil();

        // --- NEW CONFETTI / BURST LOGIC ---
        function runAnimation() {
            if (isComplete) return;
            isComplete = true; // Prevents re-firing

            // 1. Glitter Burst (Light flash effect)
            const burst = document.createElement('div');
            burst.className = 'burst-effect';
            container.appendChild(burst);

            // 2. Petals/Glitter Trail (Falls)
            for (let i = 0; i < 50; i++) {
                const petal = document.createElement('div');
                petal.className = 'petal';
                petal.style.left = `${Math.random() * 100}%`;
                petal.style.top = `${-10 - Math.random() * 20}px`; 
                petal.style.width = `${4 + Math.random() * 6}px`;
                petal.style.height = `${4 + Math.random() * 6}px`;
                petal.style.animationDuration = `${1.5 + Math.random() * 1.5}s`;
                petal.style.animationDelay = `${Math.random() * 0.5}s`;
                petal.style.animationName = 'fall';
                confettiContainer.appendChild(petal);
            }

            confettiContainer.style.opacity = 1;
            canvas.style.opacity = 0; // Fade out the remaining scratch layer
            document.querySelector('.instructions').innerText = 'The surprise is revealed!';

            setTimeout(() => {
                confettiContainer.innerHTML = '';
                if (burst && burst.parentNode) burst.parentNode.removeChild(burst);
            }, 3000);
        }
        
        function checkScratchCompletion() {
            if (isComplete) return; 

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            let currentScratched = 0;

            for (let i = 3; i < pixels.length; i += 4) {
                if (pixels[i] === 0) {
                    currentScratched++;
                }
            }

            const scratchPercentage = (currentScratched / totalPixels) * 100;

            if (scratchPercentage >= 80) { // 80% is the completion threshold
                runAnimation();
            }
        }
        
        // --- SCRATCH MECHANIC ---
        let isDrawing = false;
        function scratch(x, y) { 
            ctx.globalCompositeOperation = 'destination-out'; 
            ctx.beginPath(); 
            const angle = Math.random() * Math.PI * 2; 
            const radius = 40; 
            ctx.ellipse(x, y, radius, radius * 0.8, angle, 0, Math.PI * 2); 
            ctx.fill(); 
            
            // Check completion after every scratch event
            checkScratchCompletion();
        }

        // Event Listeners
        canvas.addEventListener('mousedown', (e) => { isDrawing = true; }); 
        canvas.addEventListener('mouseup', (e) => { isDrawing = false; checkScratchCompletion(); });
        canvas.addEventListener('mousemove', (e) => { if (isDrawing) { const rect = canvas.getBoundingClientRect(); scratch(e.clientX - rect.left, e.clientY - rect.top); } });
        canvas.addEventListener('touchstart', (e) => { isDrawing = true; }, {passive: false}); 
        canvas.addEventListener('touchend', (e) => { isDrawing = false; checkScratchCompletion(); });
        canvas.addEventListener('touchmove', (e) => { if (isDrawing) { const rect = canvas.getBoundingClientRect(); const touch = e.touches[0]; scratch(touch.clientX - rect.left, touch.clientY - rect.top); } }, {passive: false});
    </script>
</body>
</html>
